<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Member Area GMRJ</title>
    <style>
        /* --- FUTURISTIC DARK THEME VARIABLES --- */
        :root {
            /* Palette: Deep Space, Neon Cyan, Electric Purple */
            --bg-deep: #020617;
            --bg-gradient: radial-gradient(circle at top center, #1e293b 0%, #020617 100%);
            
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(148, 163, 184, 0.1);
            --glass-shine: rgba(255, 255, 255, 0.05);
            
            --color-primary: #38bdf8; /* Neon Cyan */
            --color-primary-dim: #0ea5e9;
            --color-accent: #818cf8; /* Soft Purple */
            --color-accent-glow: rgba(129, 140, 248, 0.5);
            
            --color-text: #f8fafc;
            --color-text-muted: #94a3b8;
            --color-danger: #f43f5e;
            --color-success: #10b981;
            
            --shadow-glow: 0 0 20px var(--color-accent-glow);
            --radius-xl: 24px;
            --radius-md: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background: var(--bg-deep);
            background-image: var(--bg-gradient);
            color: var(--color-text);
            min-height: 100vh;
            padding-bottom: 90px;
            overflow-x: hidden;
            background-attachment: fixed;
        }

        /* Subtle animated background noise/gradient */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.03) 0%, transparent 50%);
            animation: pulseBg 10s infinite alternate;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes pulseBg {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0.8; }
        }

        .hidden { display: none !important; }

        /* --- HEADER --- */
        header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
            color: white;
            padding: 25px 20px 80px 20px;
            text-align: center;
            position: relative;
            z-index: 50;
        }
        .app-title {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #fff 0%, var(--color-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(56, 189, 248, 0.3);
            margin-bottom: 5px;
        }
        .logout-btn {
            background: rgba(244, 63, 94, 0.15);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: #fda4af;
            padding: 6px 20px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: none;
            transition: all 0.3s ease;
        }
        .logout-btn:hover { 
            background: rgba(244, 63, 94, 0.3); 
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.4);
        }

        /* --- AUTH OVERLAY --- */
        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .auth-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid var(--glass-border);
            width: 100%;
            max-width: 380px;
            padding: 40px 30px;
            border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255,255,255,0.05);
            text-align: center;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        /* Sci-fi decorative line */
        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
        }
        @keyframes slideUp {
            from { transform: translateY(40px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .auth-logo { font-size: 40px; margin-bottom: 15px; filter: drop-shadow(0 0 10px var(--color-primary)); }
        .auth-card h2 { color: white; margin-bottom: 5px; font-weight: 700; letter-spacing: -0.5px; }
        .auth-card p { color: var(--color-text-muted); font-size: 13px; margin-bottom: 25px; }
        
        .auth-input {
            width: 100%;
            padding: 14px 16px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }
        .auth-input:focus { 
            border-color: var(--color-primary);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
        }
        /* Fix autofill colors */
        .auth-input:-webkit-autofill,
        .auth-input:-webkit-autofill:hover, 
        .auth-input:-webkit-autofill:focus {
            -webkit-text-fill-color: white;
            -webkit-box-shadow: 0 0 0px 1000px rgba(0,0,0,0.3) inset;
            transition: background-color 5000s ease-in-out 0s;
        }

        .btn-auth {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--color-primary-dim), var(--color-accent));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        .btn-auth::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(56, 189, 248, 0.4);
        }
        .btn-auth:hover::after { opacity: 1; }
        .btn-auth:active { transform: scale(0.98); }

        .toggle-link {
            display: block;
            margin-top: 20px;
            font-size: 13px;
            color: var(--color-primary);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .toggle-link:hover { color: var(--color-accent); text-decoration: underline; }
        .auth-msg { color: var(--color-danger); font-size: 12px; margin-top: 12px; min-height: 18px; text-align: left; }
        .auth-msg.success { color: var(--color-success); }

        /* --- MAIN CONTENT CARDS --- */
        main {
            padding: 0 16px;
            max-width: 800px;
            margin: -50px auto 0;
            position: relative;
            z-index: 10;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: var(--radius-xl);
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        .card-header {
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- PROFILE STYLES --- */
        .profile-container { padding: 25px; }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 16px;
        }
        .profile-row:last-child { border: none; margin-bottom: 0; padding-bottom: 0; }
        .label {
            font-size: 12px;
            color: var(--color-text-muted);
            font-weight: 600;
            margin-bottom: 6px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .value {
            font-size: 15px;
            color: var(--color-text);
            font-weight: 500;
            text-align: right;
            line-height: 1.5;
        }
        .readonly-value {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            min-width: 140px;
            text-align: right;
            color: var(--color-primary);
            font-family: monospace;
        }

        /* --- RESULT SUMMARY (POINT) --- */
        .result-summary {
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(180deg, rgba(56, 189, 248, 0.05) 0%, rgba(0,0,0,0) 100%);
            border-bottom: 1px solid var(--glass-border);
        }
        .result-name {
            font-size: 22px;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .result-id {
            font-size: 12px;
            color: var(--color-text-muted);
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            margin-bottom: 25px;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .result-score-badge {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(15, 23, 42, 1) 0%, rgba(30, 41, 59, 1) 100%);
            border: 2px solid var(--color-primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: var(--color-primary);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2), inset 0 0 20px rgba(56, 189, 248, 0.1);
            position: relative;
        }
        .result-score-badge::after {
            content: '';
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%;
            border: 1px dashed rgba(56, 189, 248, 0.3);
            animation: spin 10s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .result-score-val {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
        }
        .result-score-label {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* --- BONUS STYLES --- */
        .bonus-summary {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 78, 59, 0.2) 100%);
            padding: 35px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
            position: relative;
            overflow: hidden;
        }
        /* Glow effect behind the text */
        .bonus-summary::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150px; height: 150px;
            background: var(--color-success);
            filter: blur(80px);
            opacity: 0.2;
            z-index: 0;
        }
        .bonus-total-val {
            font-size: 32px;
            font-weight: 800;
            color: #34d399; /* Emerald 400 */
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            position: relative;
            z-index: 1;
        }
        .bonus-table-container {
            padding: 0;
            overflow-x: auto;
        }
        .bonus-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .bonus-table th {
            text-align: left;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--color-text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .bonus-table td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            color: var(--color-text);
            transition: background 0.2s;
        }
        .bonus-table tr:hover td { background: rgba(255,255,255,0.02); }
        .bonus-amount {
            font-weight: 700;
            color: #34d399;
            text-align: right;
            font-family: monospace;
            font-size: 14px;
        }

        /* --- TREE VIEW (NEON NETWORK) --- */
        .tree-container {
            padding: 30px;
            overflow: auto;
            background: rgba(0,0,0,0.2);
            min-height: 350px;
            text-align: center;
        }
        .tree ul {
            padding-top: 20px;
            position: relative;
            transition: all 0.5s;
            display: flex;
            justify-content: center;
        }
        .tree li {
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }
        /* Neon Connectors */
        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 1px solid rgba(56, 189, 248, 0.4);
            width: 50%;
            height: 20px;
            box-shadow: 0 0 5px rgba(56, 189, 248, 0.2);
        }
        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 1px solid rgba(56, 189, 248, 0.4);
        }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before {
            border-right: 1px solid rgba(56, 189, 248, 0.4);
            border-radius: 0 5px 0 0;
        }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 1px solid rgba(56, 189, 248, 0.4);
            width: 0;
            height: 20px;
            box-shadow: 0 0 5px rgba(56, 189, 248, 0.2);
        }
        
        /* Tree Node Chips */
        .tree-node {
            border: 1px solid rgba(56, 189, 248, 0.3);
            background: rgba(15, 23, 42, 0.9);
            padding: 10px 15px;
            text-decoration: none;
            color: var(--color-text);
            font-size: 11px;
            display: inline-block;
            border-radius: 8px;
            transition: all 0.3s;
            min-width: 110px;
            cursor: pointer;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(4px);
        }
        .tree-node:hover {
            border-color: var(--color-primary);
            background: rgba(56, 189, 248, 0.1);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 15px rgba(56, 189, 248, 0.2);
        }
        .tree-node strong {
            display: block;
            font-size: 13px;
            color: white;
            margin-bottom: 2px;
        }
        .tree-node small { color: var(--color-text-muted); font-size: 10px; }
        .tree-node.highlight {
            border-color: var(--color-accent);
            background: rgba(129, 140, 248, 0.15);
            box-shadow: 0 0 20px rgba(129, 140, 248, 0.3);
        }

        /* --- INFO BOARD --- */
        .info-board {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            min-height: 200px;
        }
        .info-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border-left: 3px solid var(--color-primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .info-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(56, 189, 248, 0.3);
        }
        .info-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .info-item-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }
        .info-item-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(56, 189, 248, 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(56, 189, 248, 0.2);
            text-transform: uppercase;
        }
        .info-item-date {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-top: 4px;
        }
        .info-item-content {
            font-size: 14px;
            color: var(--color-text-muted);
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .info-file-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .info-file-icon { font-size: 20px; margin-right: 10px; }
        .info-file-name { font-weight: 600; font-size: 13px; color: #e2e8f0; }
        .info-file-type { font-size: 10px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; color: var(--color-text-muted); }
        .btn-download {
            padding: 6px 12px;
            background: var(--color-primary);
            color: #0f172a;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: filter 0.2s;
        }
        .btn-download:hover { filter: brightness(1.1); }
        .info-empty { text-align: center; padding: 40px; color: var(--color-text-muted); opacity: 0.6; }

        /* --- SETTINGS --- */
        .settings-container { padding: 25px; }
        .settings-desc { color: var(--color-text-muted); font-size: 13px; margin-bottom: 20px; line-height: 1.6; }
        .settings-divider { border: 0; border-top: 1px dashed var(--glass-border); margin: 30px 0; }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 10px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.5), 0 0 20px rgba(56, 189, 248, 0.1);
            z-index: 999;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--color-text-muted);
            font-size: 10px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }
        .nav-item.active {
            color: var(--color-primary);
            transform: translateY(-2px);
        }
        .nav-item.active .nav-icon {
            transform: scale(1.2);
            text-shadow: 0 0 10px var(--color-primary);
        }

        /* --- DESKTOP NAV --- */
        @media (min-width:769px) {
            body { padding-bottom: 0; padding-top: 40px; }
            .bottom-nav { display: none; }
            .desktop-nav {
                display: flex;
                justify-content: center;
                gap: 15px;
                margin-bottom: 40px;
                position: relative;
                z-index: 20;
                padding: 0 20px;
                flex-wrap: wrap;
            }
            .desktop-btn {
                padding: 12px 30px;
                border-radius: 50px;
                border: 1px solid var(--glass-border);
                background: rgba(30, 41, 59, 0.5);
                color: var(--color-text-muted);
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                backdrop-filter: blur(5px);
                transition: all 0.3s;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .desktop-btn:hover {
                border-color: var(--color-primary);
                color: white;
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
            }
            .desktop-btn.active {
                background: var(--color-primary);
                color: #0f172a;
                border-color: var(--color-primary);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
                font-weight: 800;
            }
        }
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
        }

        /* Spinner Utility */
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- AUTH SCREEN (LOGIN & REGISTER) -->
    <div id="authOverlay">
        <!-- LOGIN FORM -->
        <div id="loginCard" class="auth-card">
            <div class="auth-logo">üîê</div>
            <h2>Login Member</h2>
            <p>Masukkan ID dan Password Anda</p>
            <input type="text" id="loginId" class="auth-input" placeholder="ID Member">
            <input type="password" id="loginPass" class="auth-input" placeholder="Password">
            <button class="btn-auth" onclick="window.attemptLogin()">MASUK</button>
            <div id="loginMsg" class="auth-msg"></div>
            <span class="toggle-link" onclick="window.toggleAuthMode()">Belum punya akun? Daftar di sini</span>
        </div>

        <!-- REGISTER FORM -->
        <div id="registerCard" class="auth-card hidden">
            <div class="auth-logo">üìù</div>
            <h2>Registrasi Member</h2>
            <p>Buat akun baru dengan ID Member Anda</p>
            <input type="text" id="regId" class="auth-input" placeholder="ID Member">
            <input type="password" id="regPass" class="auth-input" placeholder="Buat Password">
            <input type="password" id="regPassConfirm" class="auth-input" placeholder="Konfirmasi Password">
            <button class="btn-auth" onclick="window.attemptRegister()">DAFTAR</button>
            <div id="regMsg" class="auth-msg"></div>
            <span class="toggle-link" onclick="window.toggleAuthMode()">Sudah punya akun? Masuk di sini</span>
        </div>
    </div>

    <!-- APP HEADER -->
    <header>
        <div class="app-title">Member Area GMRJ</div>
        <button id="btnLogout" class="logout-btn" onclick="window.logout()">Keluar</button>
    </header>

    <!-- DESKTOP NAV -->
    <div class="desktop-nav">
        <button class="desktop-btn active" id="btn-d-profile" onclick="window.switchTab('profile')">üë§ Profil</button>
        <button class="desktop-btn" id="btn-d-member" onclick="window.switchTab('member')">‚≠ê Point Saya</button>
        <button class="desktop-btn" id="btn-d-bonus" onclick="window.switchTab('bonus')">üí∞ Bonus</button>
        <button class="desktop-btn" id="btn-d-tree" onclick="window.switchTab('tree')">üå≥ Jaringan</button>
        <button class="desktop-btn" id="btn-d-info" onclick="window.switchTab('info')">üì¢ Informasi</button>
        <button class="desktop-btn" id="btn-d-settings" onclick="window.switchTab('settings')">‚öôÔ∏è Pengaturan</button>
    </div>

    <main id="mainContent">
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    </main>

    <!-- MOBILE NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" id="btn-m-profile" onclick="window.switchTab('profile')">
            <span class="nav-icon">üë§</span>
            <span>Profil</span>
        </button>
        <button class="nav-item" id="btn-m-member" onclick="window.switchTab('member')">
            <span class="nav-icon">‚≠ê</span>
            <span>Point</span>
        </button>
        <button class="nav-item" id="btn-m-bonus" onclick="window.switchTab('bonus')">
            <span class="nav-icon">üí∞</span>
            <span>Bonus</span>
        </button>
        <button class="nav-item" id="btn-m-tree" onclick="window.switchTab('tree')">
            <span class="nav-icon">üå≥</span>
            <span>Jaringan</span>
        </button>
        <button class="nav-item" id="btn-m-info" onclick="window.switchTab('info')">
            <span class="nav-icon">üì¢</span>
            <span>Info</span>
        </button>
        <button class="nav-item" id="btn-m-settings" onclick="window.switchTab('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Pengaturan</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
            authDomain: "sistem-stokis-gmrj.firebaseapp.com",
            projectId: "sistem-stokis-gmrj",
            storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
            messagingSenderId: "288883517168",
            appId: "1:288883517168:web:d5cdd864aa944205df8435",
            measurementId: "G-12KELDXJ1J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const COLLECTION_STOKIS = "stokisDatas";
        const COLLECTION_AUTH = "memberAuth";
        const COLLECTION_PROFILES = "memberProfiles";
        const COLLECTION_INFO = "memberAnnouncements";
        const COLLECTION_PRICES = "productPrices";
        const COLLECTION_SYSTEM_CONFIG = "systemConfig";

        let globalData = null;
        let currentUser = null;
        let treeState = { nodes: [] };
        let infoBoardData = [];
        let masterProductPrices = {};
        
        // INITIALISASI WINDOW.GLOBALBONUSFILTER AGAR BISA DIBACA SECARA GLOBAL
        window.globalBonusFilter = { dateFrom: '', dateTo: '' }; 

        // Load Master Prices
        async function loadMasterPrices() {
            try {
                const docRef = doc(db, COLLECTION_PRICES, 'masterPrices');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    masterProductPrices = docSnap.data().prices || {};
                } else {
                    // Fallback prices
                    masterProductPrices = {
                        "PENDAN WULUNG": 1500000, "PHEROMONE": 50000, "A POWDER": 70000, "B POWDER": 70000, "C POWDER": 70000,
                        "A KAPSUL": 100000, "B KAPSUL": 100000, "C KAPSUL": 100000, "GM MAX": 10000, "MADU GM": 10000,
                        "TEH BMT": 20000, "TEH CELUP GM": 75000, "GODOGAN": 80000, "HB CORE": 57000, "HXA GM": 130000,
                        "MAGIC RING": 50000, "GM OIL": 70000, "GMS2": 100000, "RPGM": 50000, "SPRAY": 20000,
                        "GURAH THT": 40000, "GM MUSTIKA": 75000, "GM FRESH": 18000, "PENDAN HITAM 3D": 500000,
                        "NEW GM PELING": 50000, "GM PACE": 100000, "SPOON KUNINGAN": 75000, "VITAMAX": 20000,
                        "GM SKINCARE": 30000, "PHEROMONE BS": 60000
                    };
                }
            } catch (error) {
                console.error("Error loading master prices for bonus:", error);
            }
        }

        function cleanProductName(code, name) {
            // Helper to clean product name for price matching
            if (name && !name.toUpperCase().includes('PROD')) return name;
            if (!code) return name || "Unknown Product";
            let result = code;
            if (result.includes('_')) {
                const parts = result.split('_');
                if (parts.length >= 3) result = parts[parts.length - 1];
            }
            if (result.includes('-')) {
                const parts = result.split('-');
                if (parts.length >= 3 && parts[0].toUpperCase().includes('PROD')) {
                    result = parts.slice(2).join('-');
                }
            }
            result = result.replace(/PROD-?/gi, '');
            result = result.replace(/[^a-zA-Z0-9 ]/g, ' ');
            result = result.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
            result = result.trim();
            return result || name || "Unknown Product";
        }

        /* --- DATA PROCESSING --- */
        window.processGlobalData = function(snapshot) {
            const result = { stokisList: [], membersMap: new Map() };
            snapshot.forEach(doc => {
                const sId = doc.id;
                const sData = doc.data();
                const sName = sData.profile?.namaStokis || sId;
                let sPoints = 0;
                let sMemberCount = sData.members?.length || 0;
                let sSalesPoints = 0;

                sData.members?.forEach(m => {
                    const mId = m.id;
                    const mPoints = m.totalPoints || 0;
                    sPoints += mPoints;

                    if (!result.membersMap.has(mId)) {
                        result.membersMap.set(mId, {
                            id: mId,
                            name: m.name,
                            points: 0,
                            upline: m.upline,
                            stokisSources: [],
                            // NEW: Initialize Bonus
                            bonusTotal: 0,
                            bonusHistory: []
                        });
                    }
                    const globalMember = result.membersMap.get(mId);
                    globalMember.points += mPoints;
                    if (!globalMember.stokisSources.includes(sName)) {
                        globalMember.stokisSources.push(sName);
                    }
                    if (!globalMember.name) globalMember.name = "N/A";
                    globalMember.name = m.name;
                    if (m.upline) globalMember.upline = m.upline;
                });

                sData.transactions?.forEach(t => {
                    sSalesPoints += parseFloat(t.totalPoints || 0);

                    // NEW: BONUS CALCULATION LOGIC (7% from Unit Price)
                    // FIX: Menggunakan window.globalBonusFilter
                    const cleanProdName = cleanProductName(t.productCode, t.productName);
                    const normalize = str => str.toUpperCase().replace(/\s/g, '');
                    const normalizedInput = normalize(cleanProdName);
                    let matchedKey = Object.keys(masterProductPrices).find(k => {
                        const normalizedKey = normalize(k);
                        return normalizedKey === normalizedInput || normalizedInput.includes(normalizedKey);
                    });

                    // LOGIC: Cek Filter Tanggal Admin dari Window Object
                    let isDateMatch = true;
                    if (window.globalBonusFilter.dateFrom || window.globalBonusFilter.dateTo) {
                        const matchFrom = !window.globalBonusFilter.dateFrom || t.date >= window.globalBonusFilter.dateFrom;
                        const matchTo = !window.globalBonusFilter.dateTo || t.date <= window.globalBonusFilter.dateTo;
                        isDateMatch = matchFrom && matchTo;
                    }

                    // Hanya hitung bonus jika tanggal cocok dengan filter admin
                    if (isDateMatch) {
                        if (matchedKey) {
                            const price = masterProductPrices[matchedKey];
                            const qty = parseInt(t.qty) || 0;
                            // LOGIC: 7% dari harga satuan per produk
                            const bonusPerUnit = price * 0.07;
                            const totalBonus = bonusPerUnit * qty;

                            const member = result.membersMap.get(t.memberId);
                            if (member) {
                                member.bonusTotal += totalBonus;
                                member.bonusHistory.push({
                                    date: t.date,
                                    productName: cleanProdName,
                                    qty: qty,
                                    unitPrice: price,
                                    bonus: totalBonus
                                });
                            }
                        }
                    }
                });
                
                result.stokisList.push({
                    id: sId,
                    name: sName,
                    totalPoints: sPoints,
                    salesPoints: sSalesPoints,
                    memberCount: sMemberCount
                });
            });
            return result;
        };

        /* --- AUTH UI TOGGLE --- */
        window.toggleAuthMode = function() {
            const loginCard = document.getElementById('loginCard');
            const regCard = document.getElementById('registerCard');
            document.getElementById('loginMsg').textContent = '';
            document.getElementById('regMsg').textContent = '';

            if (loginCard.classList.contains('hidden')) {
                loginCard.classList.remove('hidden');
                regCard.classList.add('hidden');
            } else {
                loginCard.classList.add('hidden');
                regCard.classList.remove('hidden');
            }
        };

        /* --- REGISTER LOGIC --- */
        window.attemptRegister = async function() {
            const idInput = document.getElementById('regId').value.trim();
            const passInput = document.getElementById('regPass').value.trim();
            const confirmPass = document.getElementById('regPassConfirm').value.trim();
            const msg = document.getElementById('regMsg');
            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = 'Mohon isi ID dan Password.';
                return;
            }
            if (passInput !== confirmPass) {
                msg.textContent = 'Konfirmasi password tidak cocok.';
                return;
            }

            try {
                const authRef = doc(db, COLLECTION_AUTH, idInput);
                const authSnap = await getDoc(authRef);
                if (authSnap.exists()) {
                    msg.textContent = 'ID Member ini sudah terdaftar. Silakan Login.';
                    return;
                }

                if (!globalData || !globalData.membersMap.has(idInput)) {
                    msg.textContent = 'ID Member tidak ditemukan di database sistem. Hubungi Admin.';
                    return;
                }

                await setDoc(authRef, { password: passInput });
                msg.className = 'auth-msg success';
                msg.textContent = 'Registrasi Berhasil! Silakan Login.';
                document.getElementById('regId').value = '';
                document.getElementById('regPass').value = '';
                document.getElementById('regPassConfirm').value = '';
                setTimeout(() => window.toggleAuthMode(), 1500);
            } catch (error) {
                console.error(error);
                msg.textContent = 'Gagal registrasi: ' + error.message;
            }
        };

        /* --- LOGIN LOGIC --- */
        window.attemptLogin = async function() {
            const idInput = document.getElementById('loginId').value.trim();
            const passInput = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');
            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = 'Mohon isi ID dan Password.';
                return;
            }

            try {
                const docRef = doc(db, COLLECTION_AUTH, idInput);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.password === passInput) {
                        currentUser = { id: idInput, ...data };
                        if (globalData && globalData.membersMap.has(idInput)) {
                            currentUser.name = globalData.membersMap.get(idInput).name;
                        }
                        document.getElementById('authOverlay').style.display = 'none';
                        document.getElementById('btnLogout').style.display = 'inline-block';
                        window.switchTab('profile');
                    } else {
                        msg.textContent = 'Password salah!';
                    }
                } else {
                    msg.textContent = 'ID Member tidak terdaftar. Silakan Daftar.';
                }
            } catch (error) {
                console.error(error);
                msg.textContent = 'Terjadi kesalahan koneksi.';
            }
        };

        window.logout = function() {
            currentUser = null;
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('btnLogout').style.display = 'none';
            window.toggleAuthMode();
        };

        /* --- NAVIGATION & RENDER --- */
        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-item, .desktop-btn').forEach(btn => btn.classList.remove('active'));
            const mobileBtn = document.getElementById('btn-m-' + tabName);
            const desktopBtn = document.getElementById('btn-d-' + tabName);
            if(mobileBtn) mobileBtn.classList.add('active');
            if(desktopBtn) desktopBtn.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'profile') renderProfile();
            if (tabName === 'member') renderMemberView();
            if (tabName === 'bonus') renderBonusTab();
            if (tabName === 'tree') renderNetworkTree();
            if (tabName === 'info') renderInfoTab();
            if (tabName === 'settings') renderSettingsTab();
        };

        window.toggleNode = function(id) {
            function traverse(list) {
                for (const n of list) {
                    if (n.id === id) {
                        n.expanded = !n.expanded;
                        return true;
                    }
                    if (n.children && traverse(n.children)) return true;
                }
            }
            traverse(treeState.nodes);
            renderTreeHTML();
        };

        /* 1. PROFIL MEMBER (READ ONLY) */
        async function renderProfile() {
            if (!currentUser || !globalData) return;
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üë§ Profil Member</span>
                    </div>
                    <div class="profile-container" id="profileContent">
                        <div style="text-align:center; padding:20px">Memuat data profil...</div>
                    </div>
                </div>
            `;

            try {
                const profileRef = doc(db, COLLECTION_PROFILES, currentUser.id);
                const profileSnap = await getDoc(profileRef);
                let profileData = {
                    level: 'Basic',
                    phone: '',
                    address: '',
                    coords: ''
                };
                if (profileSnap.exists()) {
                    profileData = profileSnap.data();
                    if (typeof profileData.coords === 'undefined') profileData.coords = '';
                }
                
                // Render read-only HTML
                const container = document.getElementById('profileContent');
                let html = '';
                html += `<div class="profile-row"><span class="label">Nama Member</span><span class="value readonly-value">${currentUser.name}</span></div>`;
                html += `<div class="profile-row"><span class="label">ID Member</span><span class="value readonly-value">${currentUser.id}</span></div>`;
                html += '<hr style="border:0; border-top:1px dashed rgba(255,255,255,0.1); margin:20px 0">';
                html += `<div class="profile-row"><span class="label">Koordinat</span><span class="value">${profileData.coords || '-'}</span></div>`;
                html += `<div class="profile-row"><span class="label">Level Keahlian</span><span class="value">${profileData.level}</span></div>`;
                html += `<div class="profile-row"><span class="label">No HP Member</span><span class="value">${profileData.phone || '-'}</span></div>`;
                html += `<div class="profile-row"><span class="label">Alamat Member</span><span class="value">${profileData.address || '-'}</span></div>`;
                
                html += `<div style="text-align:center; margin-top:20px; font-size:12px; color:var(--color-text-muted)">
                    Untuk mengubah data profil, silakan ke menu <strong>Pengaturan</strong>.
                </div>`;

                container.innerHTML = html;

            } catch (error) {
                console.error("Error loading profile:", error);
                document.getElementById('profileContent').innerHTML = '<p style="color:var(--color-danger); text-align:center">Gagal memuat profil.</p>';
            }
        }

        /* 2. POINT MEMBER */
        function renderMemberView() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            const displayName = userData ? userData.name : currentUser.name;
            const displayPoints = userData ? userData.points : 0;

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">‚≠ê Point Member Saya</span>
                    </div>
                    <div class="result-summary">
                        <div class="result-name">${displayName}</div>
                        <div class="result-id">${currentUser.id}</div>
                        <div class="result-score-badge">
                            <div class="result-score-val">${displayPoints.toFixed(0)}</div>
                            <div class="result-score-label">Total Point</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        /* 3. TAB BONUS MEMBER (NEW - Responsive to Admin Filter, Text Updated) */
        function renderBonusTab() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            const displayName = userData ? userData.name : currentUser.name;
            const displayBonus = userData && userData.bonusTotal ? userData.bonusTotal : 0;
            const bonusHistory = userData && userData.bonusHistory ? userData.bonusHistory : [];

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üí∞ Bonus Member</span>
                    </div>
                    <div class="bonus-summary">
                        <div style="font-size:16px; color:#6ee7b7; font-weight:600; margin-bottom:5px; position:relative; z-index:1">${displayName}</div>
                        <div class="bonus-total-val">Rp ${displayBonus.toLocaleString('id-ID')}</div>
                        <div style="font-size:14px; font-weight:700; color:#34d399; text-transform:uppercase; position:relative; z-index:1">Bonus PVBV Bulanan</div>
                    </div>
                    
                    <div class="bonus-table-container">
                        <table class="bonus-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th style="text-align:center;">Qty</th>
                                    <th style="text-align:right;">Bonus (7%)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            if (bonusHistory.length === 0) {
                html += `
                    <tr>
                        <td colspan="4" style="text-align:center; padding:30px; color:var(--color-text-muted);">
                            Belum ada riwayat bonus.
                        </td>
                    </tr>
                `;
            } else {
                // Sort history by date descending
                const sortedHistory = [...bonusHistory].sort((a, b) => b.date.localeCompare(a.date));
                
                sortedHistory.forEach(item => {
                    html += `
                        <tr>
                            <td style="font-size:12px; color:var(--color-text-muted);">${item.date}</td>
                            <td style="font-weight:500;">${item.productName}</td>
                            <td style="text-align:center;">${item.qty}</td>
                            <td class="bonus-amount">Rp ${item.bonus.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        /* 4. POHON JARINGAN (COLLAPSED BY DEFAULT) */
        function renderNetworkTree() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);

            const buildSubTree = (rootMember) => {
                const allMembers = Array.from(globalData.membersMap.values());
                const children = allMembers.filter(m => m.upline === rootMember.id);
                return {
                    ...rootMember,
                    children: children.map(child => buildSubTree(child)),
                    expanded: false, // DIUBAH: false agar collapsed saat awal
                    highlight: true
                };
            };

            const rootNode = buildSubTree(userData);
            treeState.nodes = [rootNode];

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üå≥ Jaringan Saya</span>
                    </div>
                    <div class="tree-container tree" id="treeContainer"></div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            renderTreeHTML();
        }

        function renderTreeHTML() {
            const container = document.getElementById('treeContainer');
            if (!container || treeState.nodes.length === 0) return;

            const buildTreeHtml = (nodeList) => {
                if (!nodeList || nodeList.length === 0) return '';
                return '<ul>' + nodeList.map(node => {
                    const hasChildren = node.children && node.children.length > 0;
                    const isExpanded = node.expanded;
                    let childrenHtml = '';
                    if (hasChildren && isExpanded) {
                        childrenHtml = buildTreeHtml(node.children);
                    }
                    const highlightClass = node.highlight ? 'highlight' : '';
                    return `<li>
                        <div class="tree-node ${highlightClass}" onclick="window.toggleNode('${node.id.replace(/'/g, "\\'")}')">
                            ${hasChildren ? `<span style="color:var(--color-primary); margin-right:5px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : '<span style="width:12px; display:inline-block"></span>'}
                            <strong>${node.name}</strong>
                            <small>${parseFloat(node.points).toFixed(0)} pts</small>
                        </div>
                        ${childrenHtml}
                    </li>`;
                }).join('') + '</ul>';
            };

            container.innerHTML = buildTreeHtml(treeState.nodes);
        }

        /* 5. TAB INFORMASI */
        function renderInfoTab() {
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üì¢ Papan Informasi</span>
                    </div>
                    <div class="info-board" id="infoBoard">
                        <div class="info-empty">Memuat informasi...</div>
                    </div>
                </div>
            `;
            
            renderInfoBoard();
        }

        function renderInfoBoard() {
            const container = document.getElementById('infoBoard');
            if (!container) return;

            if (infoBoardData.length === 0) {
                container.innerHTML = '<div class="info-empty">Belum ada informasi yang dipublikasikan.</div>';
                return;
            }

            const sortedData = [...infoBoardData].sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt.toDate()) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt.toDate()) : new Date(0);
                return dateB - dateA;
            });

            let html = '<div class="info-items-list">';
            sortedData.forEach(item => {
                const formattedDate = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

                html += `
                    <div class="info-item">
                        <div class="info-item-header">
                            <div>
                                <div class="info-item-title">${item.title || 'Tanpa Judul'}</div>
                                <div class="info-item-date">üìÖ ${formattedDate}</div>
                            </div>
                            <span class="info-item-badge">Semua Member</span>
                        </div>
                        <div class="info-item-content">${item.content || ''}</div>
                `;

                if (item.fileUrl && item.fileName) {
                    const fileTypeDisplay = item.fileType ? item.fileType.toUpperCase() : 'FILE';
                    html += `
                        <div class="info-file-box">
                            <div class="info-file-info">
                                <span class="info-file-icon">üìÑ</span>
                                <div>
                                    <div class="info-file-name">üìé ${item.fileName} <span class="info-file-type">${fileTypeDisplay}</span></div>
                                    <div style="font-size:12px; color:var(--color-text-muted)">Klik tombol untuk download</div>
                                </div>
                            </div>
                            <a href="${item.fileUrl}" target="_blank" class="btn-download">Download</a>
                        </div>
                    `;
                }

                html += `</div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        /* 6. TAB PENGATURAN (PROFILE & PASSWORD) */
        async function renderSettingsTab() {
            if (!currentUser) return;
            const main = document.getElementById('mainContent');

            // Fetch profile data first
            let profileData = {
                level: 'Basic',
                phone: '',
                address: '',
                coords: ''
            };
            try {
                const profileRef = doc(db, COLLECTION_PROFILES, currentUser.id);
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    profileData = profileSnap.data();
                    if (typeof profileData.coords === 'undefined') profileData.coords = '';
                }
            } catch (error) {
                console.error("Error fetching profile for settings:", error);
            }

            main.innerHTML = `
                <!-- CARD 1: EDIT PROFIL -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üë§ Ubah Data Profil</span>
                    </div>
                    <div class="settings-container">
                        <p class="settings-desc">Perbarui informasi diri Anda di bawah ini.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label class="label">Koordinat</label>
                            <input type="text" id="setCoords" class="auth-input" value="${profileData.coords || ''}" placeholder="Contoh: -6.200000, 106.816666">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">Level Keahlian</label>
                            <select id="setLevel" class="auth-input">
                                <option value="Basic" ${profileData.level === 'Basic' ? 'selected' : ''}>Basic</option>
                                <option value="Advance" ${profileData.level === 'Advance' ? 'selected' : ''}>Advance</option>
                                <option value="Professional" ${profileData.level === 'Professional' ? 'selected' : ''}>Professional</option>
                                <option value="Master" ${profileData.level === 'Master' ? 'selected' : ''}>Master</option>
                                <option value="Instruktur" ${profileData.level === 'Instruktur' ? 'selected' : ''}>Instruktur</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">No HP Member</label>
                            <input type="tel" id="setPhone" class="auth-input" value="${profileData.phone || ''}" placeholder="0812...">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="label">Alamat Member</label>
                            <textarea id="setAddress" class="auth-input" style="min-height:80px; resize:vertical" placeholder="Alamat lengkap...">${profileData.address || ''}</textarea>
                        </div>

                        <div id="setProfileMsg" class="auth-msg" style="text-align:center; margin-bottom:15px"></div>
                        <button class="btn-auth" onclick="window.saveSettingsProfile()">SIMPAN PERUBAHAN PROFIL</button>
                    </div>
                </div>

                <div class="settings-divider"></div>

                <!-- CARD 2: PASSWORD -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üîí Keamanan Akun</span>
                    </div>
                    <div class="settings-container">
                        <p class="settings-desc">Ganti password untuk keamanan akun Anda.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label class="label">Password Lama</label>
                            <input type="password" id="setOldPass" class="auth-input" placeholder="Masukkan password saat ini">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">Password Baru</label>
                            <input type="password" id="setNewPass" class="auth-input" placeholder="Masukkan password baru">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="label">Konfirmasi Password Baru</label>
                            <input type="password" id="setConfirmPass" class="auth-input" placeholder="Ulangi password baru">
                        </div>

                        <div id="setPassMsg" class="auth-msg" style="text-align:center; margin-bottom:15px"></div>

                        <button id="btnUpdatePass" class="btn-auth" onclick="window.changePassword()">GANTI PASSWORD</button>
                    </div>
                </div>
            `;
        }

        window.saveSettingsProfile = async function() {
            const coords = document.getElementById('setCoords').value;
            const level = document.getElementById('setLevel').value;
            const phone = document.getElementById('setPhone').value;
            const address = document.getElementById('setAddress').value;
            const msg = document.getElementById('setProfileMsg');

            msg.className = 'auth-msg';
            msg.textContent = '';

            try {
                await setDoc(doc(db, COLLECTION_PROFILES, currentUser.id), {
                    coords: coords,
                    level: level,
                    phone: phone,
                    address: address,
                    updatedAt: new Date()
                }, { merge: true });

                msg.className = 'auth-msg success';
                msg.textContent = '‚úÖ Data Profil Berhasil Disimpan!';
                
            } catch (error) {
                console.error(error);
                msg.textContent = 'Gagal menyimpan data: ' + error.message;
            }
        };

        window.changePassword = async function() {
            const oldPass = document.getElementById('setOldPass').value.trim();
            const newPass = document.getElementById('setNewPass').value.trim();
            const confirmPass = document.getElementById('setConfirmPass').value.trim();
            const msg = document.getElementById('setPassMsg');
            const btn = document.getElementById('btnUpdatePass');

            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!oldPass || !newPass || !confirmPass) {
                msg.textContent = 'Semua kolom wajib diisi.';
                return;
            }
            if (newPass !== confirmPass) {
                msg.textContent = 'Password baru dan konfirmasi tidak cocok.';
                return;
            }
            if (newPass.length < 4) {
                msg.textContent = 'Password minimal 4 karakter.';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Memproses...';

            try {
                const authRef = doc(db, COLLECTION_AUTH, currentUser.id);
                const authSnap = await getDoc(authRef);
                
                if (!authSnap.exists()) {
                    throw new Error("Data akun tidak ditemukan.");
                }

                const currentData = authSnap.data();
                if (currentData.password !== oldPass) {
                    msg.textContent = 'Password lama salah!';
                    btn.disabled = false;
                    btn.textContent = 'GANTI PASSWORD';
                    return;
                }

                await updateDoc(authRef, {
                    password: newPass,
                    updatedAt: new Date()
                });

                msg.className = 'auth-msg success';
                msg.textContent = 'Password berhasil diubah!';

                document.getElementById('setOldPass').value = '';
                document.getElementById('setNewPass').value = '';
                document.getElementById('setConfirmPass').value = '';

                currentUser.password = newPass;

            } catch (error) {
                console.error(error);
                msg.textContent = 'Terjadi kesalahan: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'GANTI PASSWORD';
            }
        };

        // Setup realtime listener
        function setupInfoBoardListener() {
            try {
                const infoRef = collection(db, COLLECTION_INFO);
                const q = query(infoRef, orderBy('createdAt', 'desc'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    infoBoardData = [];
                    snapshot.forEach(doc => {
                        infoBoardData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    const infoBoard = document.getElementById('infoBoard');
                    if (infoBoard) {
                        renderInfoBoard();
                    }
                }, (error) => {
                    console.error("‚ùå Error listening:", error);
                });
            } catch (error) {
                console.error("‚ùå Setup error:", error);
            }
        }

        // NEW: Setup Bonus Filter Listener
        function setupBonusFilterListener() {
            try {
                const ref = doc(db, COLLECTION_SYSTEM_CONFIG, 'bonusFilter');
                
                const unsubscribe = onSnapshot(ref, async (docSnap) => {
                    if (docSnap.exists()) {
                        window.globalBonusFilter = docSnap.data();
                        
                        console.log('üîó Admin Bonus Filter Updated:', window.globalBonusFilter);
                        console.log('üîÑ Reloading Data to recalculate bonuses based on filter...');

                        // --- LOGIKA BARU: RELOAD DATA ---
                        // Penting: Panggil loadGlobalData ulang agar perhitungan bonus
                        // sesuai filter baru dijalankan ulang.
                        if (currentUser) {
                           // Tampilkan loading di tab yang sedang aktif untuk UX
                           const currentTabBtn = document.querySelector('.nav-item.active, .desktop-btn.active');
                           if(currentTabBtn) {
                               const main = document.getElementById('mainContent');
                               main.innerHTML = `<div style="padding:20px; text-align:center;"><div class="spinner"></div><p style="color:var(--color-text-muted); font-size:13px;">Memperbarui Bonus...</p></div>`;
                           }

                           await loadGlobalData();
                        }

                        // Render UI jika sedang di tab bonus
                        const mobileBtn = document.getElementById('btn-m-bonus');
                        const desktopBtn = document.getElementById('btn-d-bonus');
                        
                        if ((mobileBtn && mobileBtn.classList.contains('active')) || 
                            (desktopBtn && desktopBtn.classList.contains('active'))) {
                            renderBonusTab();
                        }
                    }
                }, (error) => {
                    console.error("Error listening to bonus filter:", error);
                });
            } catch (error) {
                console.error("Error setting up bonus filter listener:", error);
            }
        }

        // --- FUNGSI BARU: LOAD GLOBAL DATA ---
        async function loadGlobalData() {
            try {
                const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
                globalData = window.processGlobalData(stokisSnap);
            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:var(--color-danger)">
                        <h3>‚ùå Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        /* --- INIT --- */
        async function init() {
            try {
                // 1. Load Prices
                await loadMasterPrices();

                // 2. Load Data & Process (Includes Bonus Calculation)
                await loadGlobalData();
                
                // 3. Listeners
                setupInfoBoardListener();
                setupBonusFilterListener(); // NEW: Setup listener

            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:var(--color-danger)">
                        <h3>‚ùå Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        init(); 
    </script>
</body>
</html>