<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Member Area GMRJ</title>
    <style>
        /* --- MODERN BLUE THEME VARIABLES --- */
        :root {
            --color-primary: #1e3a8a;
            --color-accent: #2563eb;
            --color-bg: #eff6ff;
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --color-text-light: #64748b;
            --color-border: #dbeafe;
            --shadow-sm: 0 1px 3px 0 rgba(37, 99, 235, 0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; background: var(--color-bg); min-height: 100vh; padding-bottom: 80px; }
        
        .hidden { display: none !important; }

        /* --- HEADER & NAV --- */
        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: 30px 20px 70px 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
            text-align: center;
            position: relative;
        }
        .app-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 5px; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            display: none;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- LOGIN / REG OVERLAY --- */
        #authOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .auth-card {
            background: white;
            width: 100%;
            max-width: 350px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .auth-logo { font-size: 40px; margin-bottom: 10px; }
        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .auth-input:focus { border-color: var(--color-accent); }
        .btn-auth {
            width: 100%;
            padding: 12px;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-auth:hover { background: #1d4ed8; }
        .btn-auth:active { transform: scale(0.98); }
        
        .toggle-link {
            display: block;
            margin-top: 15px;
            font-size: 13px;
            color: var(--color-accent);
            cursor: pointer;
            text-decoration: underline;
        }
        
        .auth-msg { color: #ef4444; font-size: 12px; margin-top: 10px; min-height: 15px; text-align: left; }
        .auth-msg.success { color: #16a34a; }

        /* --- MAIN CONTENT --- */
        main { padding: 20px 16px; max-width: 800px; margin: -40px auto 0; position: relative; z-index: 10; }
        
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid white;
        }
        .card-header { padding: 16px; background: #f8fafc; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--color-primary); }
        
        /* PROFILE STYLES */
        .profile-container { padding: 20px; }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 15px;
        }
        .profile-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .label { font-size: 13px; color: var(--color-text-light); font-weight: 600; margin-bottom: 4px; display: block;}
        .value { font-size: 15px; color: var(--color-text); font-weight: 500; text-align: right; line-height: 1.4; }
        
        /* Edit Mode Inputs */
        .edit-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            color: var(--color-text);
            text-align: right;
            outline: none;
            margin-top: 5px;
        }
        .edit-input:focus { border-color: var(--color-accent); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        .edit-textarea { min-height: 80px; resize: vertical; }
        
        .readonly-value { background: #f1f5f9; padding: 8px 12px; border-radius: 6px; display: inline-block; min-width: 120px; text-align: right; }

        .btn-action {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-edit { background: white; border: 1px solid var(--color-border); color: var(--color-primary); }
        .btn-edit:hover { background: #f8fafc; border-color: var(--color-accent); }
        
        .btn-save { background: var(--color-accent); color: white; width: 100%; padding: 12px; margin-top: 10px; }
        .btn-save:hover { background: #1d4ed8; }
        
        .btn-cancel { background: #ef4444; color: white; margin-top: 10px; width: 100%; padding: 10px; border:none; border-radius:6px; cursor:pointer;}
        
        /* Result Styling (for Member Point) */
        .result-summary {
            padding: 30px 20px;
            text-align: center;
            background: #eff6ff;
            border-bottom: 1px solid var(--color-border);
        }
        .result-name { font-size: 20px; font-weight: 800; color: var(--color-primary); margin-bottom: 5px; }
        .result-id { font-size: 13px; color: var(--color-text-light); font-family: monospace; background: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 4px; margin-bottom: 15px; display: inline-block; }
        .result-score-badge {
            width: 80px; height: 80px; background: white; border: 4px solid var(--color-accent);
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto; color: var(--color-primary);
        }
        .result-score-val { font-size: 24px; font-weight: 800; line-height: 1; }
        .result-score-label { font-size: 10px; text-transform: uppercase; font-weight: 700; margin-top: 2px; }

        /* --- TREE VIEW --- */
        .tree-container { padding: 20px; overflow: auto; background: #ffffff; min-height: 300px; text-align: center; }
        .tree ul { padding-top: 20px; position: relative; transition: all 0.5s; display: flex; justify-content: center; }
        .tree li { text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #cbd5e1; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #cbd5e1; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #cbd5e1; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #cbd5e1; width: 0; height: 20px; }
        .tree-node {
            border: 1px solid var(--color-border); padding: 10px; text-decoration: none; color: var(--color-text);
            font-size: 11px; display: inline-block; border-radius: 10px; background: white; transition: all 0.3s;
            min-width: 100px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative; z-index: 2;
        }
        .tree-node:hover { border-color: var(--color-accent); background: #eff6ff; transform: translateY(-2px); }
        .tree-node strong { display: block; font-size: 13px; color: var(--color-primary); margin-bottom: 2px; }
        .tree-node small { color: var(--color-text-light); font-size: 10px; }
        .tree-node.highlight { border-color: var(--color-accent); background-color: #dbeafe; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); transform: scale(1.05); }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top: 1px solid var(--color-border); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; text-decoration: none;
            color: var(--color-text-light); font-size: 10px; font-weight: 600; background: none; border: none; cursor: pointer; flex: 1;
        }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--color-accent); }

        /* Desktop */
        @media (min-width: 769px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .desktop-nav { display: flex; justify-content: center; gap: 10px; margin-top: -40px; margin-bottom: 30px; position: relative; z-index: 20; padding: 0 20px; }
            .desktop-btn { padding: 12px 28px; border-radius: 50px; border: none; background: white; color: var(--color-text-light); font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
            .desktop-btn:hover { color: var(--color-accent); transform: translateY(-3px); }
            .desktop-btn.active { background: var(--color-accent); color: white; }
        }
        @media (max-width: 768px) { .desktop-nav { display: none; } }
    </style>
</head>
<body>

    <!-- AUTH SCREEN (LOGIN / REGISTER) -->
    <div id="authOverlay">
        
        <!-- LOGIN FORM -->
        <div id="loginCard" class="auth-card">
            <div class="auth-logo">üîê</div>
            <h2 style="color:var(--color-primary); margin-bottom:5px;">Login Member</h2>
            <p style="color:var(--color-text-light); font-size:13px; margin-bottom:20px;">Masukkan ID dan Password Anda</p>
            
            <input type="text" id="loginId" class="auth-input" placeholder="ID Member">
            <input type="password" id="loginPass" class="auth-input" placeholder="Password">
            
            <button class="btn-auth" onclick="window.attemptLogin()">MASUK</button>
            <div id="loginMsg" class="auth-msg"></div>
            
            <span class="toggle-link" onclick="window.toggleAuthMode()">Belum punya akun? Daftar di sini</span>
        </div>

        <!-- REGISTER FORM -->
        <div id="registerCard" class="auth-card hidden">
            <div class="auth-logo">üìù</div>
            <h2 style="color:var(--color-primary); margin-bottom:5px;">Registrasi Member</h2>
            <p style="color:var(--color-text-light); font-size:13px; margin-bottom:20px;">Buat akun baru dengan ID Member Anda</p>
            
            <input type="text" id="regId" class="auth-input" placeholder="ID Member">
            <input type="password" id="regPass" class="auth-input" placeholder="Buat Password">
            <input type="password" id="regPassConfirm" class="auth-input" placeholder="Konfirmasi Password">
            
            <button class="btn-auth" onclick="window.attemptRegister()">DAFTAR</button>
            <div id="regMsg" class="auth-msg"></div>
            
            <span class="toggle-link" onclick="window.toggleAuthMode()">Sudah punya akun? Masuk di sini</span>
        </div>

    </div>

    <!-- APP HEADER -->
    <header>
        <div class="app-title">Member Area GMRJ</div>
        <button id="btnLogout" class="logout-btn" onclick="window.logout()">Keluar</button>
    </header>

    <!-- DESKTOP NAV -->
    <div class="desktop-nav">
        <button class="desktop-btn active" id="btn-d-profile" onclick="window.switchTab('profile')">üë§ Profil</button>
        <button class="desktop-btn" id="btn-d-member" onclick="window.switchTab('member')">üíé Point Saya</button>
        <button class="desktop-btn" id="btn-d-tree" onclick="window.switchTab('tree')">üå≥ Jaringan</button>
    </div>

    <main id="mainContent">
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    </main>

    <!-- MOBILE NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" id="btn-m-profile" onclick="window.switchTab('profile')">
            <span class="nav-icon">üë§</span>
            <span>Profil</span>
        </button>
        <button class="nav-item" id="btn-m-member" onclick="window.switchTab('member')">
            <span class="nav-icon">üíé</span>
            <span>Point Saya</span>
        </button>
        <button class="nav-item" id="btn-m-tree" onclick="window.switchTab('tree')">
            <span class="nav-icon">üå≥</span>
            <span>Jaringan</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
            authDomain: "sistem-stokis-gmrj.firebaseapp.com",
            projectId: "sistem-stokis-gmrj",
            storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
            messagingSenderId: "288883517168",
            appId: "1:288883517168:web:d5cdd864aa944205df8435",
            measurementId: "G-12KELDXJ1J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_STOKIS = 'stokisDatas';
        const COLLECTION_AUTH = 'memberAuth';
        const COLLECTION_PROFILES = 'memberProfiles'; // Koleksi baru untuk data editan

        let globalData = null;
        let currentUser = null;
        let treeState = { nodes: [] };

        // --- DATA PROCESSING ---
        window.processGlobalData = function(snapshot) {
            const result = {
                stokisList: [],
                membersMap: new Map()
            };

            snapshot.forEach(doc => {
                const sId = doc.id;
                const sData = doc.data();
                const sName = sData.profile?.namaStokis || sId;
                let sPoints = 0;
                let sMemberCount = sData.members?.length || 0;
                let sSalesPoints = 0;

                sData.members?.forEach(m => {
                    const mId = m.id;
                    const mPoints = m.totalPoints || 0;
                    sPoints += mPoints;

                    if (!result.membersMap.has(mId)) {
                        result.membersMap.set(mId, {
                            id: mId,
                            name: m.name,
                            points: 0,
                            upline: m.upline,
                            stokisSources: []
                        });
                    }

                    const globalMember = result.membersMap.get(mId);
                    globalMember.points += mPoints;
                    
                    // Tambah Stokis ke source jika belum ada
                    if (!globalMember.stokisSources.includes(sName)) {
                        globalMember.stokisSources.push(sName);
                    }

                    if (!globalMember.name || globalMember.name === 'NA') globalMember.name = m.name;
                    if (m.upline) globalMember.upline = m.upline;
                });

                sData.transactions?.forEach(t => {
                    sSalesPoints += parseFloat(t.totalPoints || 0);
                });

                result.stokisList.push({
                    id: sId,
                    name: sName,
                    totalPoints: sPoints,
                    salesPoints: sSalesPoints,
                    memberCount: sMemberCount
                });
            });
            return result;
        };

        // --- AUTH UI TOGGLE ---
        window.toggleAuthMode = function() {
            const loginCard = document.getElementById('loginCard');
            const regCard = document.getElementById('registerCard');
            document.getElementById('loginMsg').textContent = '';
            document.getElementById('regMsg').textContent = '';
            
            if (loginCard.classList.contains('hidden')) {
                loginCard.classList.remove('hidden');
                regCard.classList.add('hidden');
            } else {
                loginCard.classList.add('hidden');
                regCard.classList.remove('hidden');
            }
        };

        // --- REGISTER LOGIC ---
        window.attemptRegister = async function() {
            const idInput = document.getElementById('regId').value.trim();
            const passInput = document.getElementById('regPass').value.trim();
            const confirmPass = document.getElementById('regPassConfirm').value.trim();
            const msg = document.getElementById('regMsg');

            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = "Mohon isi ID dan Password.";
                return;
            }

            if (passInput !== confirmPass) {
                msg.textContent = "Konfirmasi password tidak cocok.";
                return;
            }

            try {
                const authRef = doc(db, COLLECTION_AUTH, idInput);
                const authSnap = await getDoc(authRef);
                
                if (authSnap.exists()) {
                    msg.textContent = "ID Member ini sudah terdaftar. Silakan Login.";
                    return;
                }

                if (!globalData || !globalData.membersMap.has(idInput)) {
                    msg.textContent = "ID Member tidak ditemukan di database sistem. Hubungi Admin.";
                    return;
                }

                await setDoc(authRef, { password: passInput });
                
                msg.className = 'auth-msg success';
                msg.textContent = "Registrasi Berhasil! Silakan Login.";
                
                document.getElementById('regId').value = '';
                document.getElementById('regPass').value = '';
                document.getElementById('regPassConfirm').value = '';

                setTimeout(() => { window.toggleAuthMode(); }, 1500);

            } catch (error) {
                console.error(error);
                msg.textContent = "Gagal registrasi: " + error.message;
            }
        };

        // --- LOGIN LOGIC ---
        window.attemptLogin = async function() {
            const idInput = document.getElementById('loginId').value.trim();
            const passInput = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');

            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = "Mohon isi ID dan Password.";
                return;
            }

            try {
                const docRef = doc(db, COLLECTION_AUTH, idInput);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.password === passInput) {
                        currentUser = { id: idInput, ...data };
                        if (globalData && globalData.membersMap.has(idInput)) {
                            currentUser.name = globalData.membersMap.get(idInput).name;
                        }

                        document.getElementById('authOverlay').style.display = 'none';
                        document.getElementById('btnLogout').style.display = 'inline-block';
                        
                        window.switchTab('profile'); // Default tab is Profile
                    } else {
                        msg.textContent = "Password salah!";
                    }
                } else {
                    msg.textContent = "ID Member tidak terdaftar. Silakan Daftar.";
                }
            } catch (error) {
                console.error(error);
                msg.textContent = "Terjadi kesalahan koneksi.";
            }
        };

        window.logout = function() {
            currentUser = null;
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('btnLogout').style.display = 'none';
            window.toggleAuthMode(); 
        };

        // --- NAVIGATION & RENDER ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-item, .desktop-btn').forEach(btn => btn.classList.remove('active'));
            
            const mobileBtn = document.getElementById(`btn-m-${tabName}`);
            const desktopBtn = document.getElementById(`btn-d-${tabName}`);
            if(mobileBtn) mobileBtn.classList.add('active');
            if(desktopBtn) desktopBtn.classList.add('active');

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'profile') renderProfile();
            if (tabName === 'member') renderMemberView();
            if (tabName === 'tree') renderNetworkTree();
        };

        window.toggleNode = function(id) {
            function traverse(list) {
                for (const n of list) {
                    if (n.id === id) {
                        n.expanded = !n.expanded;
                        return true;
                    }
                    if (n.children && traverse(n.children)) return true;
                }
            }
            traverse(treeState.nodes);
            renderTreeHTML();
        };

        // 1. PROFIL MEMBER
        let isEditingProfile = false;
        
        async function renderProfile() {
            if (!currentUser || !globalData) return;
            
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üë§ Profil Member</span>
                        <div id="profileActions"></div>
                    </div>
                    <div class="profile-container" id="profileContent">
                        <div style="text-align:center; padding:20px;">Memuat data profil...</div>
                    </div>
                </div>
            `;

            try {
                // Ambil data editan dari koleksi memberProfiles
                const profileRef = doc(db, COLLECTION_PROFILES, currentUser.id);
                const profileSnap = await getDoc(profileRef);
                
                // Inisialisasi data default termasuk koordinat
                let profileData = { 
                    level: 'Basic', 
                    phone: '', 
                    address: '',
                    coords: '' // Koordinat diinisialisasi kosong
                };
                
                if (profileSnap.exists()) {
                    profileData = profileSnap.data();
                    // Pastikan field koordinat ada
                    if (typeof profileData.coords === 'undefined') profileData.coords = '';
                }

                renderProfileHTML(currentUser.name, currentUser.id, profileData);

            } catch (error) {
                console.error("Error loading profile:", error);
                document.getElementById('profileContent').innerHTML = `<p style="color:red; text-align:center;">Gagal memuat profil.</p>`;
            }
        }

        function renderProfileHTML(name, id, pData) {
            const container = document.getElementById('profileContent');
            const actionsContainer = document.getElementById('profileActions');
            
            // HTML helper function
            const rowHtml = (label, value, isReadonly = false, type = 'text') => {
                if (isEditingProfile && !isReadonly) {
                    if (type === 'select') {
                        const options = ['Basic', 'Advance', 'Professional', 'Master', 'Instruktur']
                            .map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('');
                        return `
                            <div class="profile-row" style="flex-direction:column; align-items:flex-start;">
                                <span class="label">${label}</span>
                                <select class="edit-input" id="input_${label.replace(/\s/g, '')}">
                                    ${options}
                                </select>
                            </div>
                        `;
                    } else if (type === 'textarea') {
                        return `
                            <div class="profile-row" style="flex-direction:column; align-items:flex-start;">
                                <span class="label">${label}</span>
                                <textarea class="edit-input edit-textarea" id="input_${label.replace(/\s/g, '')}" placeholder="Isi ${label}...">${value}</textarea>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="profile-row" style="flex-direction:column; align-items:flex-start;">
                                <span class="label">${label}</span>
                                <input type="${type}" class="edit-input" id="input_${label.replace(/\s/g, '')}" value="${value}" placeholder="Contoh: -6.200000, 106.816666">
                            </div>
                        `;
                    }
                } else {
                    return `
                        <div class="profile-row">
                            <span class="label">${label}</span>
                            <span class="value ${isReadonly ? 'readonly-value' : ''}">${value || '-'}</span>
                        </div>
                    `;
                }
            };

            let html = '';
            
            // 1. Read Only Fields (Nama & ID)
            html += rowHtml('Nama Member', name, true);
            html += rowHtml('ID Member', id, true);
            // Stokis DIHAPUS sesuai request

            html += `<hr style="border:0; border-top:1px dashed #e2e8f0; margin:20px 0;">`;

            // 2. Editable Fields (Koordinat, Level, HP, Alamat)
            // Koordinat dipindahkan ke sini agar bisa diedit member
            html += rowHtml('Koordinat', pData.coords || '', false, 'text'); 
            html += rowHtml('Level Keahlian', pData.level, false, 'select');
            html += rowHtml('No HP Member', pData.phone, false, 'tel');
            html += rowHtml('Alamat Member', pData.address, false, 'textarea');

            // Action Buttons
            let btnHtml = '';
            if (isEditingProfile) {
                btnHtml = `
                    <div style="margin-top:20px;">
                        <button class="btn-action btn-save" onclick="window.saveProfile()">SIMPAN PERUBAHAN</button>
                        <button class="btn-action btn-cancel" onclick="window.cancelEditProfile()">BATAL</button>
                    </div>
                `;
            } else {
                btnHtml = `<button class="btn-action btn-edit" onclick="window.enableEditProfile()">Edit Profil</button>`;
            }

            container.innerHTML = html + btnHtml;
            actionsContainer.innerHTML = isEditingProfile ? '<span style="font-size:12px; color:var(--color-accent); font-weight:bold;">Mode Edit</span>' : '';
        }

        window.enableEditProfile = function() {
            isEditingProfile = true;
            renderProfile();
        }

        window.cancelEditProfile = function() {
            isEditingProfile = false;
            renderProfile();
        }

        window.saveProfile = async function() {
            // Ambil semua nilai dari input
            const coords = document.getElementById('input_Koordinat').value;
            const level = document.getElementById('input_LevelKeahlian').value;
            const phone = document.getElementById('input_NoHPMember').value;
            const address = document.getElementById('input_AlamatMember').value;

            const btn = document.querySelector('.btn-save');
            const originalText = btn.textContent;
            btn.textContent = 'Menyimpan...';
            btn.disabled = true;

            try {
                await setDoc(doc(db, COLLECTION_PROFILES, currentUser.id), {
                    coords: coords,
                    level: level,
                    phone: phone,
                    address: address,
                    updatedAt: new Date()
                }, { merge: true });

                isEditingProfile = false;
                renderProfile(); // Re-render untuk melihat data tersimpan
                
                // Feedback sukses
                const title = document.querySelector('.card-title');
                const originalTitle = title.textContent;
                title.textContent = "‚úÖ Data Berhasil Disimpan!";
                title.style.color = "#16a34a";
                setTimeout(() => {
                    title.textContent = originalTitle;
                    title.style.color = "";
                }, 2000);

            } catch (error) {
                console.error(error);
                alert("Gagal menyimpan data: " + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // 2. POINT MEMBER
        function renderMemberView() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            const displayName = userData ? userData.name : currentUser.name;
            const displayPoints = userData ? userData.points : 0;

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üíé Point Member Saya</span>
                    </div>
                    <div class="result-summary">
                        <div class="result-name">${displayName}</div>
                        <div class="result-id">${currentUser.id}</div>
                        <div class="result-score-badge" style="border-color: var(--color-primary);">
                            <div class="result-score-val" style="color:var(--color-primary)">${displayPoints.toFixed(0)}</div>
                            <div class="result-score-label">Total Point</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        // 3. POHON JARINGAN
        function renderNetworkTree() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            
            const buildSubTree = (rootMember) => {
                const allMembers = Array.from(globalData.membersMap.values());
                const children = allMembers.filter(m => m.upline === rootMember.id);
                return {
                    ...rootMember,
                    children: children.map(child => buildSubTree(child)),
                    expanded: true,
                    highlight: true
                };
            };

            const rootNode = buildSubTree(userData);
            treeState.nodes = [rootNode];
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üå≥ Jaringan Saya</span>
                    </div>
                    <div class="tree-container tree" id="treeContainer"></div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            renderTreeHTML();
        }

        function renderTreeHTML() {
            const container = document.getElementById('treeContainer');
            if (!container || treeState.nodes.length === 0) return;

            const buildTreeHtml = (nodeList) => {
                if (!nodeList || nodeList.length === 0) return '';
                return `<ul>${nodeList.map(node => {
                    const hasChildren = node.children && node.children.length > 0;
                    const isExpanded = node.expanded;
                    let childrenHtml = '';
                    if (hasChildren && isExpanded) {
                        childrenHtml = buildTreeHtml(node.children);
                    }
                    const highlightClass = node.highlight ? 'highlight' : '';

                    return `
                        <li>
                            <div class="tree-node ${highlightClass}" onclick="window.toggleNode('${node.id.replace(/'/g, "\\'")}')">
                                ${hasChildren 
                                    ? `<span style="color:var(--color-accent); margin-right:5px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` 
                                    : `<span style="width:12px; display:inline-block;"></span>`
                                }
                                <strong>${node.name}</strong>
                                <small>${parseFloat(node.points).toFixed(0)} pts</small>
                            </div>
                            ${childrenHtml}
                        </li>
                    `;
                }).join('')}</ul>`;
            };

            container.innerHTML = buildTreeHtml(treeState.nodes);
        }

        async function init() {
            try {
                const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
                globalData = window.processGlobalData(stokisSnap);
            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:#ef4444;">
                        <h3>‚ö†Ô∏è Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>