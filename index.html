<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Skema Point GMRJ</title>
    <style>
        /* --- MODERN BLUE THEME VARIABLES --- */
        :root {
            --color-primary: #1e3a8a;
            --color-primary-light: #3b82f6;
            --color-accent: #2563eb;
            --color-bg: #eff6ff;
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --color-text-light: #64748b;
            --color-border: #dbeafe;
            --shadow-sm: 0 1px 3px 0 rgba(37, 99, 235, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: 30px 20px 70px 20px; 
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
            text-align: center;
        }

        .app-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }

        main {
            padding: 20px 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            color: var(--color-text-light);
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--color-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            border: 1px solid white;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--color-border);
        }

        .card-title { font-size: 16px; font-weight: 700; color: var(--color-primary); margin-bottom: 10px; display:block; }

        /* Search & Action Area */
        .search-container {
            padding: 20px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-box:focus { border-color: var(--color-accent); }

        .btn-primary {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:active { transform: scale(0.98); }

        /* Result Area Styles */
        .result-summary {
            padding: 30px 20px;
            text-align: center;
            background: #eff6ff;
            border-bottom: 1px solid var(--color-border);
        }

        .result-name {
            font-size: 20px;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .result-id {
            font-size: 13px;
            color: var(--color-text-light);
            margin-bottom: 15px;
            font-family: monospace;
            background: rgba(255,255,255,0.5);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .result-score-badge {
            width: 80px;
            height: 80px;
            background: white;
            border: 4px solid var(--color-accent);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: var(--color-primary);
        }

        .result-score-val { font-size: 24px; font-weight: 800; line-height: 1; }
        .result-score-label { font-size: 10px; text-transform: uppercase; font-weight: 700; margin-top: 2px; }

        .empty-state {
            padding: 30px;
            text-align: center;
            color: var(--color-text-light);
            font-size: 14px;
        }

        /* --- TREE VIEW --- */
        .tree-container {
            padding: 20px;
            overflow: auto;
            background: #ffffff;
            min-height: 300px;
            text-align: center;
        }

        .tree ul {
            padding-top: 20px;
            position: relative;
            transition: all 0.5s;
            display: flex;
            justify-content: center;
            padding-left: 0;
        }

        .tree li {
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }

        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 1px solid #cbd5e1;
            width: 50%;
            height: 20px;
        }
        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 1px solid #cbd5e1;
        }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #cbd5e1; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 1px solid #cbd5e1;
            width: 0;
            height: 20px;
        }

        .tree-node {
            border: 1px solid var(--color-border);
            padding: 10px;
            text-decoration: none;
            color: var(--color-text);
            font-size: 11px;
            display: inline-block;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            z-index: 2;
        }

        .tree-node:hover {
            border-color: var(--color-accent);
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
        }

        .tree-node strong { display: block; font-size: 13px; color: var(--color-primary); margin-bottom: 2px; }
        .tree-node small { color: var(--color-text-light); font-size: 10px; }

        .tree-node.highlight {
            border-color: var(--color-accent);
            background-color: #dbeafe;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
            transform: scale(1.05);
        }
        .tree-node.highlight strong { color: var(--color-primary); }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--color-text-light);
            font-size: 10px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }

        .nav-item.active { color: var(--color-accent); }
        .nav-item.active .nav-icon { transform: translateY(-2px); }

        /* --- DESKTOP LAYOUT --- */
        @media (min-width: 769px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .desktop-nav {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: -40px; 
                margin-bottom: 30px;
                position: relative;
                z-index: 20; 
                padding: 0 20px;
            }
            .desktop-btn {
                padding: 12px 28px;
                border-radius: 50px;
                border: none;
                background: white;
                color: var(--color-text-light);
                font-weight: 700;
                font-size: 14px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                cursor: pointer;
                transition: all 0.3s;
            }
            .desktop-btn:hover { 
                color: var(--color-accent); 
                transform: translateY(-3px); 
                box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            }
            .desktop-btn.active {
                background: var(--color-accent);
                color: white;
                box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            }
        }
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .app-title { font-size: 18px; }
            header { padding-bottom: 24px; } 
        }
    </style>
</head>
<body>

    <header>
        <div class="app-title">Skema Point GMRJ</div>
    </header>

    <div class="desktop-nav">
        <button class="desktop-btn active" id="btn-d-stokis" onclick="window.switchTab('stokis')">üèÜ Point Stokis</button>
        <button class="desktop-btn" id="btn-d-member" onclick="window.switchTab('member')">üíé Point Member</button>
        <button class="desktop-btn" id="btn-d-tree" onclick="window.switchTab('tree')">üå≥ Pohon Jaringan</button>
    </div>

    <main id="mainContent">
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" id="btn-m-stokis" onclick="window.switchTab('stokis')">
            <span class="nav-icon">üèÜ</span>
            <span>Point Stokis</span>
        </button>
        <button class="nav-item" id="btn-m-member" onclick="window.switchTab('member')">
            <span class="nav-icon">üíé</span>
            <span>Point Member</span>
        </button>
        <button class="nav-item" id="btn-m-tree" onclick="window.switchTab('tree')">
            <span class="nav-icon">üå≥</span>
            <span>Pohon Jaringan</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
            authDomain: "sistem-stokis-gmrj.firebaseapp.com",
            projectId: "sistem-stokis-gmrj",
            storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
            messagingSenderId: "288883517168",
            appId: "1:288883517168:web:d5cdd864aa944205df8435",
            measurementId: "G-12KELDXJ1J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_STOKIS = 'stokisDatas';

        let globalData = null;
        let treeState = { nodes: [] };

        // --- GLOBAL HELPER FUNCTIONS ---
        window.processGlobalData = function(snapshot) {
            const result = {
                stokisList: [],
                membersMap: new Map()
            };

            snapshot.forEach(doc => {
                const sId = doc.id;
                const sData = doc.data();
                const sName = sData.profile?.namaStokis || sId;
                let sPoints = 0;
                let sMemberCount = sData.members?.length || 0;
                let sSalesPoints = 0;

                sData.members?.forEach(m => {
                    const mId = m.id;
                    const mPoints = m.totalPoints || 0;
                    sPoints += mPoints;

                    if (!result.membersMap.has(mId)) {
                        result.membersMap.set(mId, {
                            id: mId,
                            name: m.name,
                            points: 0,
                            upline: m.upline,
                            stokisSources: []
                        });
                    }

                    const globalMember = result.membersMap.get(mId);
                    globalMember.points += mPoints;
                    globalMember.stokisSources.push(sName);
                    if (!globalMember.name || globalMember.name === 'NA') globalMember.name = m.name;
                    if (m.upline) globalMember.upline = m.upline;
                });

                sData.transactions?.forEach(t => {
                    sSalesPoints += parseFloat(t.totalPoints || 0);
                });

                result.stokisList.push({
                    id: sId,
                    name: sName,
                    totalPoints: sPoints,
                    salesPoints: sSalesPoints,
                    memberCount: sMemberCount
                });
            });
            return result;
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-item, .desktop-btn').forEach(btn => btn.classList.remove('active'));
            
            const mobileBtn = document.getElementById(`btn-m-${tabName}`);
            const desktopBtn = document.getElementById(`btn-d-${tabName}`);
            if(mobileBtn) mobileBtn.classList.add('active');
            if(desktopBtn) desktopBtn.classList.add('active');

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'stokis') renderStokisSearch();
            if (tabName === 'member') renderMemberSearch();
            if (tabName === 'tree') renderNetworkTree();
        };

        window.toggleNode = function(id) {
            function traverse(list) {
                for (const n of list) {
                    if (n.id === id) {
                        n.expanded = !n.expanded;
                        return true;
                    }
                    if (n.children && traverse(n.children)) return true;
                }
            }
            traverse(treeState.nodes);
            renderTreeHTML();
        };

        // --- RENDER FUNCTIONS ---

        // 1. POINT STOKIS
        function renderStokisSearch() {
            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üèÜ Point Stokis</span>
                    </div>
                    <div class="search-container">
                        <input type="text" id="inputStokisName" class="search-box" placeholder="Ketik Nama Stokis...">
                        <button class="btn-primary" onclick="window.handleSearchStokis()">Cari Stokis</button>
                    </div>
                    <div id="stokisResultArea"></div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        window.handleSearchStokis = function() {
            const query = document.getElementById('inputStokisName').value.toLowerCase().trim();
            const resultArea = document.getElementById('stokisResultArea');
            
            if (!query) {
                resultArea.innerHTML = `<div class="empty-state">Silakan masukkan nama stokis.</div>`;
                return;
            }

            const found = globalData.stokisList.find(s => s.name.toLowerCase().includes(query));

            if (found) {
                resultArea.innerHTML = `
                    <div class="result-summary">
                        <div class="result-name">${found.name}</div>
                        <div class="result-id">${found.id}</div>
                        <div class="result-score-badge">
                            <div class="result-score-val">${found.salesPoints.toFixed(0)}</div>
                            <div class="result-score-label">Omset Point</div>
                        </div>
                    </div>
                `;
            } else {
                resultArea.innerHTML = `<div class="empty-state">Stokis dengan nama "<strong>${query}</strong>" tidak ditemukan.</div>`;
            }
        };

        // 2. POINT MEMBER
        function renderMemberSearch() {
            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üíé Point Member</span>
                    </div>
                    <div class="search-container">
                        <input type="text" id="inputMemberID" class="search-box" placeholder="Ketik ID Member...">
                        <button class="btn-primary" onclick="window.handleSearchMember()">Cari Member</button>
                    </div>
                    <div id="memberResultArea"></div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        window.handleSearchMember = function() {
            const query = document.getElementById('inputMemberID').value.toLowerCase().trim();
            const resultArea = document.getElementById('memberResultArea');

            if (!query) {
                resultArea.innerHTML = `<div class="empty-state">Silakan masukkan ID member.</div>`;
                return;
            }

            // Search using Array.from on Map values
            const allMembers = Array.from(globalData.membersMap.values());
            const found = allMembers.find(m => m.id.toLowerCase().includes(query));

            if (found) {
                resultArea.innerHTML = `
                    <div class="result-summary">
                        <div class="result-name">${found.name}</div>
                        <div class="result-id">${found.id}</div>
                        <div class="result-score-badge" style="border-color: var(--color-primary);">
                            <div class="result-score-val" style="color:var(--color-primary)">${found.points.toFixed(0)}</div>
                            <div class="result-score-label">Total Point</div>
                        </div>
                    </div>
                `;
            } else {
                resultArea.innerHTML = `<div class="empty-state">Member dengan ID "<strong>${query}</strong>" tidak ditemukan.</div>`;
            }
        };

        // 3. POHON JARINGAN
        function renderNetworkTree() {
            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üå≥ Pohon Jaringan</span>
                    </div>
                    <div class="search-container">
                        <input type="text" id="inputTreeSearch" class="search-box" placeholder="Ketik Nama / ID Member...">
                        <button class="btn-primary" onclick="window.handleSearchTree()">Cari Jaringan</button>
                    </div>
                    <div class="tree-container tree" id="treeContainer">
                         <div class="empty-state" style="padding: 50px;">Silakan cari member untuk melihat jaringan ke bawah.</div>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        window.handleSearchTree = function() {
            const query = document.getElementById('inputTreeSearch').value.toLowerCase().trim();
            const container = document.getElementById('treeContainer');

            if (!query) return;

            // Find the member
            const allMembers = Array.from(globalData.membersMap.values());
            const foundMember = allMembers.find(m => 
                m.name.toLowerCase().includes(query) || 
                m.id.toLowerCase().includes(query)
            );

            if (foundMember) {
                // Build sub-tree structure starting from foundMember
                // We need to recursively find children
                const buildSubTree = (rootMember) => {
                    const children = allMembers.filter(m => m.upline === rootMember.id);
                    return {
                        ...rootMember,
                        children: children.map(child => buildSubTree(child)),
                        expanded: true, // Auto expand root
                        highlight: true // Highlight root
                    };
                };

                const rootNode = buildSubTree(foundMember);
                treeState.nodes = [rootNode];
                
                renderTreeHTML();
            } else {
                container.innerHTML = `<div class="empty-state">Data "<strong>${query}</strong>" tidak ditemukan.</div>`;
                treeState.nodes = [];
            }
        };

        function renderTreeHTML() {
            const container = document.getElementById('treeContainer');
            if (!container || treeState.nodes.length === 0) return;

            const buildTreeHtml = (nodeList) => {
                if (!nodeList || nodeList.length === 0) return '';
                return `<ul>${nodeList.map(node => {
                    const hasChildren = node.children && node.children.length > 0;
                    const isExpanded = node.expanded;
                    let childrenHtml = '';
                    if (hasChildren && isExpanded) {
                        childrenHtml = buildTreeHtml(node.children);
                    }
                    
                    const highlightClass = node.highlight ? 'highlight' : '';

                    return `
                        <li>
                            <div class="tree-node ${highlightClass}" onclick="window.toggleNode('${node.id.replace(/'/g, "\\'")}')">
                                ${hasChildren 
                                    ? `<span style="color:var(--color-accent); margin-right:5px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` 
                                    : `<span style="width:12px; display:inline-block;"></span>`
                                }
                                <strong>${node.name}</strong>
                                <small>${parseFloat(node.points).toFixed(0)} pts</small>
                            </div>
                            ${childrenHtml}
                        </li>
                    `;
                }).join('')}</ul>`;
            };

            container.innerHTML = buildTreeHtml(treeState.nodes);
        }

        async function init() {
            try {
                const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
                globalData = window.processGlobalData(stokisSnap);
                window.switchTab('stokis');
            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:#ef4444;">
                        <h3>‚ö†Ô∏è Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>