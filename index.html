<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Member Area GMRJ</title>
    <style>
        /* --- MODERN BLUE THEME VARIABLES --- */
        :root {
            --color-primary: #1e3a8a;
            --color-accent: #2563eb;
            --color-bg: #eff6ff;
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --color-text-light: #64748b;
            --color-border: #dbeafe;
            --shadow-sm: 0 1px 3px 0 rgba(37, 99, 235, 0.1);
            --radius: 12px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: sans-serif;
            background: var(--color-bg);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .hidden { display: none !important; }

        /* --- HEADER NAV --- */
        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            padding: 30px 20px 70px 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
            text-align: center;
            position: relative;
        }
        .app-title {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 5px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            display: none;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- LOGIN & REG OVERLAY --- */
        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .auth-card {
            background: white;
            width: 100%;
            max-width: 350px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .auth-logo { font-size: 40px; margin-bottom: 10px; }
        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .auth-input:focus { border-color: var(--color-accent); }
        .btn-auth {
            width: 100%;
            padding: 12px;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-auth:hover { background: #1d4ed8; }
        .btn-auth:active { transform: scale(0.98); }
        .toggle-link {
            display: block;
            margin-top: 15px;
            font-size: 13px;
            color: var(--color-accent);
            cursor: pointer;
            text-decoration: underline;
        }
        .auth-msg {
            color: #ef4444;
            font-size: 12px;
            margin-top: 10px;
            min-height: 15px;
            text-align: left;
        }
        .auth-msg.success { color: #16a34a; }

        /* --- MAIN CONTENT --- */
        main {
            padding: 20px 16px;
            max-width: 800px;
            margin: -40px auto 0;
            position: relative;
            z-index: 10;
        }
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid white;
        }
        .card-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-primary);
        }

        /* PROFILE STYLES */
        .profile-container { padding: 20px; }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 15px;
        }
        .profile-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .label {
            font-size: 13px;
            color: var(--color-text-light);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }
        .value {
            font-size: 15px;
            color: var(--color-text);
            font-weight: 500;
            text-align: right;
            line-height: 1.4;
        }
        .readonly-value {
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            min-width: 120px;
            text-align: right;
        }

        /* Result Styling for Member Point */
        .result-summary {
            padding: 30px 20px;
            text-align: center;
            background: #eff6ff;
            border-bottom: 1px solid var(--color-border);
        }
        .result-name {
            font-size: 20px;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        .result-id {
            font-size: 13px;
            color: var(--color-text-light);
            font-family: monospace;
            background: rgba(255,255,255,0.5);
            padding: 2px 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .result-score-badge {
            width: 80px;
            height: 80px;
            background: white;
            border: 4px solid var(--color-accent);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: var(--color-primary);
        }
        .result-score-val {
            font-size: 24px;
            font-weight: 800;
            line-height: 1;
        }
        .result-score-label {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            margin-top: 2px;
        }

        /* --- BONUS TAB STYLES --- */
        .bonus-summary {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #a7f3d0;
        }
        .bonus-total-val {
            font-size: 28px;
            font-weight: 800;
            color: #059669;
            margin: 5px 0;
        }
        .bonus-table-container {
            padding: 0;
            overflow-x: auto;
        }
        .bonus-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .bonus-table th {
            text-align: left;
            padding: 12px 16px;
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .bonus-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--color-text);
        }
        .bonus-table tr:last-child td {
            border-bottom: none;
        }
        .bonus-amount {
            font-weight: 700;
            color: #059669;
            text-align: right;
        }

        /* --- TREE VIEW --- */
        .tree-container {
            padding: 20px;
            overflow: auto;
            background: #ffffff;
            min-height: 300px;
            text-align: center;
        }
        .tree ul {
            padding-top: 20px;
            position: relative;
            transition: all 0.5s;
            display: flex;
            justify-content: center;
        }
        .tree li {
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }
        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 1px solid #cbd5e1;
            width: 50%;
            height: 20px;
        }
        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 1px solid #cbd5e1;
        }
        .tree li:only-child::after, .tree li:only-child::before {
            display: none;
        }
        .tree li:only-child {
            padding-top: 0;
        }
        .tree li:first-child::before, .tree li:last-child::after {
            border: 0 none;
        }
        .tree li:last-child::before {
            border-right: 1px solid #cbd5e1;
            border-radius: 0 5px 0 0;
        }
        .tree li:first-child::after {
            border-radius: 5px 0 0 0;
        }
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 1px solid #cbd5e1;
            width: 0;
            height: 20px;
        }
        .tree-node {
            border: 1px solid var(--color-border);
            padding: 10px;
            text-decoration: none;
            color: var(--color-text);
            font-size: 11px;
            display: inline-block;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        .tree-node:hover {
            border-color: var(--color-accent);
            background: #eff6ff;
            transform: translateY(-2px);
        }
        .tree-node strong {
            display: block;
            font-size: 13px;
            color: var(--color-primary);
            margin-bottom: 2px;
        }
        .tree-node small {
            color: var(--color-text-light);
            font-size: 10px;
        }
        .tree-node.highlight {
            border-color: var(--color-accent);
            background-color: #dbeafe;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
            transform: scale(1.05);
        }

        /* --- INFO BOARD STYLES --- */
        .info-board {
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 200px;
        }
        .info-items-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .info-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #0284c7;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        .info-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .info-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0f2fe;
        }
        .info-item-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-text);
        }
        .info-item-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            background: #dbeafe;
            color: var(--color-primary);
        }
        .info-item-date {
            font-size: 11px;
            color: var(--color-text-light);
            font-weight: 600;
            margin-top: 5px;
        }
        .info-item-content {
            font-size: 14px;
            color: var(--color-text);
            line-height: 1.7;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .info-file-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .info-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-file-icon {
            font-size: 24px;
        }
        .info-file-name {
            font-weight: 600;
            font-size: 14px;
            color: #0369a1;
        }
        .info-file-type {
            font-size: 11px;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        .btn-download {
            padding: 8px 16px;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-download:hover {
            background: #1d4ed8;
        }
        .info-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-light);
            font-size: 14px;
        }
        .info-empty::before {
            content: 'üì≠';
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }

        /* --- SETTINGS TAB STYLES --- */
        .settings-container {
            padding: 20px;
        }
        .settings-desc {
            font-size: 13px;
            color: var(--color-text-light);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .settings-divider {
            border: 0;
            border-top: 1px dashed var(--color-border);
            margin: 30px 0;
        }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 999;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--color-text-light);
            font-size: 10px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            flex: 1;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--color-accent);
        }

        /* Desktop */
        @media (min-width:769px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .desktop-nav {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: -40px;
                margin-bottom: 30px;
                position: relative;
                z-index: 20;
                padding: 0 20px;
                flex-wrap: wrap;
            }
            .desktop-btn {
                padding: 12px 28px;
                border-radius: 50px;
                border: none;
                background: white;
                color: var(--color-text-light);
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }
            .desktop-btn:hover {
                color: var(--color-accent);
                transform: translateY(-3px);
            }
            .desktop-btn.active {
                background: var(--color-accent);
                color: white;
            }
        }
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN (LOGIN & REGISTER) -->
    <div id="authOverlay">
        <!-- LOGIN FORM -->
        <div id="loginCard" class="auth-card">
            <div class="auth-logo">üîê</div>
            <h2 style="color:var(--color-primary); margin-bottom:5px">Login Member</h2>
            <p style="color:var(--color-text-light); font-size:13px; margin-bottom:20px">Masukkan ID dan Password Anda</p>
            <input type="text" id="loginId" class="auth-input" placeholder="ID Member">
            <input type="password" id="loginPass" class="auth-input" placeholder="Password">
            <button class="btn-auth" onclick="window.attemptLogin()">MASUK</button>
            <div id="loginMsg" class="auth-msg"></div>
            <span class="toggle-link" onclick="window.toggleAuthMode()">Belum punya akun? Daftar di sini</span>
        </div>

        <!-- REGISTER FORM -->
        <div id="registerCard" class="auth-card hidden">
            <div class="auth-logo">üìù</div>
            <h2 style="color:var(--color-primary); margin-bottom:5px">Registrasi Member</h2>
            <p style="color:var(--color-text-light); font-size:13px; margin-bottom:20px">Buat akun baru dengan ID Member Anda</p>
            <input type="text" id="regId" class="auth-input" placeholder="ID Member">
            <input type="password" id="regPass" class="auth-input" placeholder="Buat Password">
            <input type="password" id="regPassConfirm" class="auth-input" placeholder="Konfirmasi Password">
            <button class="btn-auth" onclick="window.attemptRegister()">DAFTAR</button>
            <div id="regMsg" class="auth-msg"></div>
            <span class="toggle-link" onclick="window.toggleAuthMode()">Sudah punya akun? Masuk di sini</span>
        </div>
    </div>

    <!-- APP HEADER -->
    <header>
        <div class="app-title">Member Area GMRJ</div>
        <button id="btnLogout" class="logout-btn" onclick="window.logout()">Keluar</button>
    </header>

    <!-- DESKTOP NAV -->
    <div class="desktop-nav">
        <button class="desktop-btn active" id="btn-d-profile" onclick="window.switchTab('profile')">üë§ Profil</button>
        <button class="desktop-btn" id="btn-d-member" onclick="window.switchTab('member')">‚≠ê Point Saya</button>
        <button class="desktop-btn" id="btn-d-bonus" onclick="window.switchTab('bonus')">üí∞ Bonus</button>
        <button class="desktop-btn" id="btn-d-tree" onclick="window.switchTab('tree')">üå≥ Jaringan</button>
        <button class="desktop-btn" id="btn-d-info" onclick="window.switchTab('info')">üì¢ Informasi</button>
        <button class="desktop-btn" id="btn-d-settings" onclick="window.switchTab('settings')">‚öôÔ∏è Pengaturan</button>
    </div>

    <main id="mainContent">
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    </main>

    <!-- MOBILE NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" id="btn-m-profile" onclick="window.switchTab('profile')">
            <span class="nav-icon">üë§</span>
            <span>Profil</span>
        </button>
        <button class="nav-item" id="btn-m-member" onclick="window.switchTab('member')">
            <span class="nav-icon">‚≠ê</span>
            <span>Point</span>
        </button>
        <button class="nav-item" id="btn-m-bonus" onclick="window.switchTab('bonus')">
            <span class="nav-icon">üí∞</span>
            <span>Bonus</span>
        </button>
        <button class="nav-item" id="btn-m-tree" onclick="window.switchTab('tree')">
            <span class="nav-icon">üå≥</span>
            <span>Jaringan</span>
        </button>
        <button class="nav-item" id="btn-m-info" onclick="window.switchTab('info')">
            <span class="nav-icon">üì¢</span>
            <span>Info</span>
        </button>
        <button class="nav-item" id="btn-m-settings" onclick="window.switchTab('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Pengaturan</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, orderBy, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
            authDomain: "sistem-stokis-gmrj.firebaseapp.com",
            projectId: "sistem-stokis-gmrj",
            storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
            messagingSenderId: "288883517168",
            appId: "1:288883517168:web:d5cdd864aa944205df8435",
            measurementId: "G-12KELDXJ1J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const COLLECTION_STOKIS = "stokisDatas";
        const COLLECTION_AUTH = "memberAuth";
        const COLLECTION_PROFILES = "memberProfiles";
        const COLLECTION_INFO = "memberAnnouncements";
        const COLLECTION_PRICES = "productPrices";
        const COLLECTION_SYSTEM_CONFIG = "systemConfig";

        let globalData = null;
        let currentUser = null;
        let treeState = { nodes: [] };
        let infoBoardData = [];
        let masterProductPrices = {};
        
        // INITIALISASI WINDOW.GLOBALBONUSFILTER AGAR BISA DIBACA SECARA GLOBAL
        window.globalBonusFilter = { dateFrom: '', dateTo: '' }; 

        // Load Master Prices
        async function loadMasterPrices() {
            try {
                const docRef = doc(db, COLLECTION_PRICES, 'masterPrices');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    masterProductPrices = docSnap.data().prices || {};
                } else {
                    // Fallback prices
                    masterProductPrices = {
                        "PENDAN WULUNG": 1500000, "PHEROMONE": 50000, "A POWDER": 70000, "B POWDER": 70000, "C POWDER": 70000,
                        "A KAPSUL": 100000, "B KAPSUL": 100000, "C KAPSUL": 100000, "GM MAX": 10000, "MADU GM": 10000,
                        "TEH BMT": 20000, "TEH CELUP GM": 75000, "GODOGAN": 80000, "HB CORE": 57000, "HXA GM": 130000,
                        "MAGIC RING": 50000, "GM OIL": 70000, "GMS2": 100000, "RPGM": 50000, "SPRAY": 20000,
                        "GURAH THT": 40000, "GM MUSTIKA": 75000, "GM FRESH": 18000, "PENDAN HITAM 3D": 500000,
                        "NEW GM PELING": 50000, "GM PACE": 100000, "SPOON KUNINGAN": 75000, "VITAMAX": 20000,
                        "GM SKINCARE": 30000, "PHEROMONE BS": 60000
                    };
                }
            } catch (error) {
                console.error("Error loading master prices for bonus:", error);
            }
        }

        function cleanProductName(code, name) {
            // Helper to clean product name for price matching
            if (name && !name.toUpperCase().includes('PROD')) return name;
            if (!code) return name || "Unknown Product";
            let result = code;
            if (result.includes('_')) {
                const parts = result.split('_');
                if (parts.length >= 3) result = parts[parts.length - 1];
            }
            if (result.includes('-')) {
                const parts = result.split('-');
                if (parts.length >= 3 && parts[0].toUpperCase().includes('PROD')) {
                    result = parts.slice(2).join('-');
                }
            }
            result = result.replace(/PROD-?/gi, '');
            result = result.replace(/[^a-zA-Z0-9 ]/g, ' ');
            result = result.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
            result = result.trim();
            return result || name || "Unknown Product";
        }

        /* --- DATA PROCESSING --- */
        window.processGlobalData = function(snapshot) {
            const result = { stokisList: [], membersMap: new Map() };
            snapshot.forEach(doc => {
                const sId = doc.id;
                const sData = doc.data();
                const sName = sData.profile?.namaStokis || sId;
                let sPoints = 0;
                let sMemberCount = sData.members?.length || 0;
                let sSalesPoints = 0;

                sData.members?.forEach(m => {
                    const mId = m.id;
                    const mPoints = m.totalPoints || 0;
                    sPoints += mPoints;

                    if (!result.membersMap.has(mId)) {
                        result.membersMap.set(mId, {
                            id: mId,
                            name: m.name,
                            points: 0,
                            upline: m.upline,
                            stokisSources: [],
                            // NEW: Initialize Bonus
                            bonusTotal: 0,
                            bonusHistory: []
                        });
                    }
                    const globalMember = result.membersMap.get(mId);
                    globalMember.points += mPoints;
                    if (!globalMember.stokisSources.includes(sName)) {
                        globalMember.stokisSources.push(sName);
                    }
                    if (!globalMember.name) globalMember.name = "N/A";
                    globalMember.name = m.name;
                    if (m.upline) globalMember.upline = m.upline;
                });

                sData.transactions?.forEach(t => {
                    sSalesPoints += parseFloat(t.totalPoints || 0);

                    // NEW: BONUS CALCULATION LOGIC (7% from Unit Price)
                    // FIX: Menggunakan window.globalBonusFilter
                    const cleanProdName = cleanProductName(t.productCode, t.productName);
                    const normalize = str => str.toUpperCase().replace(/\s/g, '');
                    const normalizedInput = normalize(cleanProdName);
                    let matchedKey = Object.keys(masterProductPrices).find(k => {
                        const normalizedKey = normalize(k);
                        return normalizedKey === normalizedInput || normalizedInput.includes(normalizedKey);
                    });

                    // LOGIC: Cek Filter Tanggal Admin dari Window Object
                    let isDateMatch = true;
                    if (window.globalBonusFilter.dateFrom || window.globalBonusFilter.dateTo) {
                        const matchFrom = !window.globalBonusFilter.dateFrom || t.date >= window.globalBonusFilter.dateFrom;
                        const matchTo = !window.globalBonusFilter.dateTo || t.date <= window.globalBonusFilter.dateTo;
                        isDateMatch = matchFrom && matchTo;
                    }

                    // Hanya hitung bonus jika tanggal cocok dengan filter admin
                    if (isDateMatch) {
                        if (matchedKey) {
                            const price = masterProductPrices[matchedKey];
                            const qty = parseInt(t.qty) || 0;
                            // LOGIC: 7% dari harga satuan per produk
                            const bonusPerUnit = price * 0.07;
                            const totalBonus = bonusPerUnit * qty;

                            const member = result.membersMap.get(t.memberId);
                            if (member) {
                                member.bonusTotal += totalBonus;
                                member.bonusHistory.push({
                                    date: t.date,
                                    productName: cleanProdName,
                                    qty: qty,
                                    unitPrice: price,
                                    bonus: totalBonus
                                });
                            }
                        }
                    }
                });
                
                result.stokisList.push({
                    id: sId,
                    name: sName,
                    totalPoints: sPoints,
                    salesPoints: sSalesPoints,
                    memberCount: sMemberCount
                });
            });
            return result;
        };

        /* --- AUTH UI TOGGLE --- */
        window.toggleAuthMode = function() {
            const loginCard = document.getElementById('loginCard');
            const regCard = document.getElementById('registerCard');
            document.getElementById('loginMsg').textContent = '';
            document.getElementById('regMsg').textContent = '';

            if (loginCard.classList.contains('hidden')) {
                loginCard.classList.remove('hidden');
                regCard.classList.add('hidden');
            } else {
                loginCard.classList.add('hidden');
                regCard.classList.remove('hidden');
            }
        };

        /* --- REGISTER LOGIC --- */
        window.attemptRegister = async function() {
            const idInput = document.getElementById('regId').value.trim();
            const passInput = document.getElementById('regPass').value.trim();
            const confirmPass = document.getElementById('regPassConfirm').value.trim();
            const msg = document.getElementById('regMsg');
            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = 'Mohon isi ID dan Password.';
                return;
            }
            if (passInput !== confirmPass) {
                msg.textContent = 'Konfirmasi password tidak cocok.';
                return;
            }

            try {
                const authRef = doc(db, COLLECTION_AUTH, idInput);
                const authSnap = await getDoc(authRef);
                if (authSnap.exists()) {
                    msg.textContent = 'ID Member ini sudah terdaftar. Silakan Login.';
                    return;
                }

                if (!globalData || !globalData.membersMap.has(idInput)) {
                    msg.textContent = 'ID Member tidak ditemukan di database sistem. Hubungi Admin.';
                    return;
                }

                await setDoc(authRef, { password: passInput });
                msg.className = 'auth-msg success';
                msg.textContent = 'Registrasi Berhasil! Silakan Login.';
                document.getElementById('regId').value = '';
                document.getElementById('regPass').value = '';
                document.getElementById('regPassConfirm').value = '';
                setTimeout(() => window.toggleAuthMode(), 1500);
            } catch (error) {
                console.error(error);
                msg.textContent = 'Gagal registrasi: ' + error.message;
            }
        };

        /* --- LOGIN LOGIC --- */
        window.attemptLogin = async function() {
            const idInput = document.getElementById('loginId').value.trim();
            const passInput = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');
            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!idInput || !passInput) {
                msg.textContent = 'Mohon isi ID dan Password.';
                return;
            }

            try {
                const docRef = doc(db, COLLECTION_AUTH, idInput);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.password === passInput) {
                        currentUser = { id: idInput, ...data };
                        if (globalData && globalData.membersMap.has(idInput)) {
                            currentUser.name = globalData.membersMap.get(idInput).name;
                        }
                        document.getElementById('authOverlay').style.display = 'none';
                        document.getElementById('btnLogout').style.display = 'inline-block';
                        window.switchTab('profile');
                    } else {
                        msg.textContent = 'Password salah!';
                    }
                } else {
                    msg.textContent = 'ID Member tidak terdaftar. Silakan Daftar.';
                }
            } catch (error) {
                console.error(error);
                msg.textContent = 'Terjadi kesalahan koneksi.';
            }
        };

        window.logout = function() {
            currentUser = null;
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPass').value = '';
            document.getElementById('btnLogout').style.display = 'none';
            window.toggleAuthMode();
        };

        /* --- NAVIGATION & RENDER --- */
        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-item, .desktop-btn').forEach(btn => btn.classList.remove('active'));
            const mobileBtn = document.getElementById('btn-m-' + tabName);
            const desktopBtn = document.getElementById('btn-d-' + tabName);
            if(mobileBtn) mobileBtn.classList.add('active');
            if(desktopBtn) desktopBtn.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'profile') renderProfile();
            if (tabName === 'member') renderMemberView();
            if (tabName === 'bonus') renderBonusTab();
            if (tabName === 'tree') renderNetworkTree();
            if (tabName === 'info') renderInfoTab();
            if (tabName === 'settings') renderSettingsTab();
        };

        window.toggleNode = function(id) {
            function traverse(list) {
                for (const n of list) {
                    if (n.id === id) {
                        n.expanded = !n.expanded;
                        return true;
                    }
                    if (n.children && traverse(n.children)) return true;
                }
            }
            traverse(treeState.nodes);
            renderTreeHTML();
        };

        /* 1. PROFIL MEMBER (READ ONLY) */
        async function renderProfile() {
            if (!currentUser || !globalData) return;
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üë§ Profil Member</span>
                    </div>
                    <div class="profile-container" id="profileContent">
                        <div style="text-align:center; padding:20px">Memuat data profil...</div>
                    </div>
                </div>
            `;

            try {
                const profileRef = doc(db, COLLECTION_PROFILES, currentUser.id);
                const profileSnap = await getDoc(profileRef);
                let profileData = {
                    level: 'Basic',
                    phone: '',
                    address: '',
                    coords: ''
                };
                if (profileSnap.exists()) {
                    profileData = profileSnap.data();
                    if (typeof profileData.coords === 'undefined') profileData.coords = '';
                }
                
                // Render read-only HTML
                const container = document.getElementById('profileContent');
                let html = '';
                html += `<div class="profile-row"><span class="label">Nama Member</span><span class="value readonly-value">${currentUser.name}</span></div>`;
                html += `<div class="profile-row"><span class="label">ID Member</span><span class="value readonly-value">${currentUser.id}</span></div>`;
                html += '<hr style="border:0; border-top:1px dashed #e2e8f0; margin:20px 0">';
                html += `<div class="profile-row"><span class="label">Koordinat</span><span class="value">${profileData.coords || '-'}</span></div>`;
                html += `<div class="profile-row"><span class="label">Level Keahlian</span><span class="value">${profileData.level}</span></div>`;
                html += `<div class="profile-row"><span class="label">No HP Member</span><span class="value">${profileData.phone || '-'}</span></div>`;
                html += `<div class="profile-row"><span class="label">Alamat Member</span><span class="value">${profileData.address || '-'}</span></div>`;
                
                html += `<div style="text-align:center; margin-top:20px; font-size:12px; color:var(--color-text-light)">
                    Untuk mengubah data profil, silakan ke menu <strong>Pengaturan</strong>.
                </div>`;

                container.innerHTML = html;

            } catch (error) {
                console.error("Error loading profile:", error);
                document.getElementById('profileContent').innerHTML = '<p style="color:red; text-align:center">Gagal memuat profil.</p>';
            }
        }

        /* 2. POINT MEMBER */
        function renderMemberView() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            const displayName = userData ? userData.name : currentUser.name;
            const displayPoints = userData ? userData.points : 0;

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">‚≠ê Point Member Saya</span>
                    </div>
                    <div class="result-summary">
                        <div class="result-name">${displayName}</div>
                        <div class="result-id">${currentUser.id}</div>
                        <div class="result-score-badge" style="border-color: var(--color-primary)">
                            <div class="result-score-val" style="color:var(--color-primary)">${displayPoints.toFixed(0)}</div>
                            <div class="result-score-label">Total Point</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        /* 3. TAB BONUS MEMBER (NEW - Responsive to Admin Filter, Text Updated) */
        function renderBonusTab() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);
            const displayName = userData ? userData.name : currentUser.name;
            const displayBonus = userData && userData.bonusTotal ? userData.bonusTotal : 0;
            const bonusHistory = userData && userData.bonusHistory ? userData.bonusHistory : [];

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üí∞ Bonus Member</span>
                    </div>
                    <div class="bonus-summary">
                        <div style="font-size:16px; color:#065f46; font-weight:600; margin-bottom:5px;">${displayName}</div>
                        <div class="bonus-total-val">Rp ${displayBonus.toLocaleString('id-ID')}</div>
                        <!-- DIUBAH: Total Bonus Terkumpul -> Bonus PVBV Bulanan -->
                        <div style="font-size:14px; font-weight:700; color:#047857; font-weight:600; text-transform:uppercase;">Bonus PVBV Bulanan</div>
                        
                        <!-- BARIS INFO PERIODE TANGGAL DIHAPUS (DIREQUEST) -->
                    </div>
                    
                    <div class="bonus-table-container">
                        <table class="bonus-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th style="text-align:center;">Qty</th>
                                    <th style="text-align:right;">Bonus (7%)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            if (bonusHistory.length === 0) {
                html += `
                    <tr>
                        <td colspan="4" style="text-align:center; padding:30px; color:#94a3b8;">
                            Belum ada riwayat bonus.
                        </td>
                    </tr>
                `;
            } else {
                // Sort history by date descending
                const sortedHistory = [...bonusHistory].sort((a, b) => b.date.localeCompare(a.date));
                
                sortedHistory.forEach(item => {
                    html += `
                        <tr>
                            <td style="font-size:12px; color:#64748b;">${item.date}</td>
                            <td style="font-weight:500;">${item.productName}</td>
                            <td style="text-align:center;">${item.qty}</td>
                            <td class="bonus-amount">Rp ${item.bonus.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
        }

        /* 4. POHON JARINGAN (COLLAPSED BY DEFAULT) */
        function renderNetworkTree() {
            if (!currentUser || !globalData) return;
            const userData = globalData.membersMap.get(currentUser.id);

            const buildSubTree = (rootMember) => {
                const allMembers = Array.from(globalData.membersMap.values());
                const children = allMembers.filter(m => m.upline === rootMember.id);
                return {
                    ...rootMember,
                    children: children.map(child => buildSubTree(child)),
                    expanded: false, // DIUBAH: false agar collapsed saat awal
                    highlight: true
                };
            };

            const rootNode = buildSubTree(userData);
            treeState.nodes = [rootNode];

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üå≥ Jaringan Saya</span>
                    </div>
                    <div class="tree-container tree" id="treeContainer"></div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            renderTreeHTML();
        }

        function renderTreeHTML() {
            const container = document.getElementById('treeContainer');
            if (!container || treeState.nodes.length === 0) return;

            const buildTreeHtml = (nodeList) => {
                if (!nodeList || nodeList.length === 0) return '';
                return '<ul>' + nodeList.map(node => {
                    const hasChildren = node.children && node.children.length > 0;
                    const isExpanded = node.expanded;
                    let childrenHtml = '';
                    if (hasChildren && isExpanded) {
                        childrenHtml = buildTreeHtml(node.children);
                    }
                    const highlightClass = node.highlight ? 'highlight' : '';
                    return `<li>
                        <div class="tree-node ${highlightClass}" onclick="window.toggleNode('${node.id.replace(/'/g, "\\'")}')">
                            ${hasChildren ? `<span style="color:var(--color-accent); margin-right:5px">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` : '<span style="width:12px; display:inline-block"></span>'}
                            <strong>${node.name}</strong>
                            <small>${parseFloat(node.points).toFixed(0)} pts</small>
                        </div>
                        ${childrenHtml}
                    </li>`;
                }).join('') + '</ul>';
            };

            container.innerHTML = buildTreeHtml(treeState.nodes);
        }

        /* 5. TAB INFORMASI */
        function renderInfoTab() {
            const main = document.getElementById('mainContent');
            main.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üì¢ Papan Informasi</span>
                    </div>
                    <div class="info-board" id="infoBoard">
                        <div class="info-empty">Memuat informasi...</div>
                    </div>
                </div>
            `;
            
            renderInfoBoard();
        }

        function renderInfoBoard() {
            const container = document.getElementById('infoBoard');
            if (!container) return;

            if (infoBoardData.length === 0) {
                container.innerHTML = '<div class="info-empty">Belum ada informasi yang dipublikasikan.</div>';
                return;
            }

            const sortedData = [...infoBoardData].sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt.toDate()) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt.toDate()) : new Date(0);
                return dateB - dateA;
            });

            let html = '<div class="info-items-list">';
            sortedData.forEach(item => {
                const formattedDate = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

                html += `
                    <div class="info-item">
                        <div class="info-item-header">
                            <div>
                                <div class="info-item-title">${item.title || 'Tanpa Judul'}</div>
                                <div class="info-item-date">üìÖ ${formattedDate}</div>
                            </div>
                            <span class="info-item-badge">Semua Member</span>
                        </div>
                        <div class="info-item-content">${item.content || ''}</div>
                `;

                if (item.fileUrl && item.fileName) {
                    const fileTypeDisplay = item.fileType ? item.fileType.toUpperCase() : 'FILE';
                    html += `
                        <div class="info-file-box">
                            <div class="info-file-info">
                                <span class="info-file-icon">üìÑ</span>
                                <div>
                                    <div class="info-file-name">üìé ${item.fileName} <span class="info-file-type">${fileTypeDisplay}</span></div>
                                    <div style="font-size:12px; color:#64748b">Klik tombol untuk download</div>
                                </div>
                            </div>
                            <a href="${item.fileUrl}" target="_blank" class="btn-download">Download</a>
                        </div>
                    `;
                }

                html += `</div>`;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        /* 6. TAB PENGATURAN (PROFILE & PASSWORD) */
        async function renderSettingsTab() {
            if (!currentUser) return;
            const main = document.getElementById('mainContent');

            // Fetch profile data first
            let profileData = {
                level: 'Basic',
                phone: '',
                address: '',
                coords: ''
            };
            try {
                const profileRef = doc(db, COLLECTION_PROFILES, currentUser.id);
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    profileData = profileSnap.data();
                    if (typeof profileData.coords === 'undefined') profileData.coords = '';
                }
            } catch (error) {
                console.error("Error fetching profile for settings:", error);
            }

            main.innerHTML = `
                <!-- CARD 1: EDIT PROFIL -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üë§ Ubah Data Profil</span>
                    </div>
                    <div class="settings-container">
                        <p class="settings-desc">Perbarui informasi diri Anda di bawah ini.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label class="label">Koordinat</label>
                            <input type="text" id="setCoords" class="auth-input" value="${profileData.coords || ''}" placeholder="Contoh: -6.200000, 106.816666">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">Level Keahlian</label>
                            <select id="setLevel" class="auth-input">
                                <option value="Basic" ${profileData.level === 'Basic' ? 'selected' : ''}>Basic</option>
                                <option value="Advance" ${profileData.level === 'Advance' ? 'selected' : ''}>Advance</option>
                                <option value="Professional" ${profileData.level === 'Professional' ? 'selected' : ''}>Professional</option>
                                <option value="Master" ${profileData.level === 'Master' ? 'selected' : ''}>Master</option>
                                <option value="Instruktur" ${profileData.level === 'Instruktur' ? 'selected' : ''}>Instruktur</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">No HP Member</label>
                            <input type="tel" id="setPhone" class="auth-input" value="${profileData.phone || ''}" placeholder="0812...">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="label">Alamat Member</label>
                            <textarea id="setAddress" class="auth-input" style="min-height:80px; resize:vertical" placeholder="Alamat lengkap...">${profileData.address || ''}</textarea>
                        </div>

                        <div id="setProfileMsg" class="auth-msg" style="text-align:center; margin-bottom:15px"></div>
                        <button class="btn-auth" onclick="window.saveSettingsProfile()">SIMPAN PERUBAHAN PROFIL</button>
                    </div>
                </div>

                <div class="settings-divider"></div>

                <!-- CARD 2: PASSWORD -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üîí Keamanan Akun</span>
                    </div>
                    <div class="settings-container">
                        <p class="settings-desc">Ganti password untuk keamanan akun Anda.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label class="label">Password Lama</label>
                            <input type="password" id="setOldPass" class="auth-input" placeholder="Masukkan password saat ini">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label class="label">Password Baru</label>
                            <input type="password" id="setNewPass" class="auth-input" placeholder="Masukkan password baru">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label class="label">Konfirmasi Password Baru</label>
                            <input type="password" id="setConfirmPass" class="auth-input" placeholder="Ulangi password baru">
                        </div>

                        <div id="setPassMsg" class="auth-msg" style="text-align:center; margin-bottom:15px"></div>

                        <button id="btnUpdatePass" class="btn-auth" onclick="window.changePassword()">GANTI PASSWORD</button>
                    </div>
                </div>
            `;
        }

        window.saveSettingsProfile = async function() {
            const coords = document.getElementById('setCoords').value;
            const level = document.getElementById('setLevel').value;
            const phone = document.getElementById('setPhone').value;
            const address = document.getElementById('setAddress').value;
            const msg = document.getElementById('setProfileMsg');

            msg.className = 'auth-msg';
            msg.textContent = '';

            try {
                await setDoc(doc(db, COLLECTION_PROFILES, currentUser.id), {
                    coords: coords,
                    level: level,
                    phone: phone,
                    address: address,
                    updatedAt: new Date()
                }, { merge: true });

                msg.className = 'auth-msg success';
                msg.textContent = '‚úÖ Data Profil Berhasil Disimpan!';
                
            } catch (error) {
                console.error(error);
                msg.textContent = 'Gagal menyimpan data: ' + error.message;
            }
        };

        window.changePassword = async function() {
            const oldPass = document.getElementById('setOldPass').value.trim();
            const newPass = document.getElementById('setNewPass').value.trim();
            const confirmPass = document.getElementById('setConfirmPass').value.trim();
            const msg = document.getElementById('setPassMsg');
            const btn = document.getElementById('btnUpdatePass');

            msg.className = 'auth-msg';
            msg.textContent = '';

            if (!oldPass || !newPass || !confirmPass) {
                msg.textContent = 'Semua kolom wajib diisi.';
                return;
            }
            if (newPass !== confirmPass) {
                msg.textContent = 'Password baru dan konfirmasi tidak cocok.';
                return;
            }
            if (newPass.length < 4) {
                msg.textContent = 'Password minimal 4 karakter.';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Memproses...';

            try {
                const authRef = doc(db, COLLECTION_AUTH, currentUser.id);
                const authSnap = await getDoc(authRef);
                
                if (!authSnap.exists()) {
                    throw new Error("Data akun tidak ditemukan.");
                }

                const currentData = authSnap.data();
                if (currentData.password !== oldPass) {
                    msg.textContent = 'Password lama salah!';
                    btn.disabled = false;
                    btn.textContent = 'GANTI PASSWORD';
                    return;
                }

                await updateDoc(authRef, {
                    password: newPass,
                    updatedAt: new Date()
                });

                msg.className = 'auth-msg success';
                msg.textContent = 'Password berhasil diubah!';

                document.getElementById('setOldPass').value = '';
                document.getElementById('setNewPass').value = '';
                document.getElementById('setConfirmPass').value = '';

                currentUser.password = newPass;

            } catch (error) {
                console.error(error);
                msg.textContent = 'Terjadi kesalahan: ' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'GANTI PASSWORD';
            }
        };

        // Setup realtime listener
        function setupInfoBoardListener() {
            try {
                const infoRef = collection(db, COLLECTION_INFO);
                const q = query(infoRef, orderBy('createdAt', 'desc'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    infoBoardData = [];
                    snapshot.forEach(doc => {
                        infoBoardData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    const infoBoard = document.getElementById('infoBoard');
                    if (infoBoard) {
                        renderInfoBoard();
                    }
                }, (error) => {
                    console.error("‚ùå Error listening:", error);
                });
            } catch (error) {
                console.error("‚ùå Setup error:", error);
            }
        }

        // NEW: Setup Bonus Filter Listener
        function setupBonusFilterListener() {
            try {
                const ref = doc(db, COLLECTION_SYSTEM_CONFIG, 'bonusFilter');
                
                const unsubscribe = onSnapshot(ref, async (docSnap) => {
                    if (docSnap.exists()) {
                        window.globalBonusFilter = docSnap.data();
                        
                        console.log('üîó Admin Bonus Filter Updated:', window.globalBonusFilter);
                        console.log('üîÑ Reloading Data to recalculate bonuses based on filter...');

                        // --- LOGIKA BARU: RELOAD DATA ---
                        // Penting: Panggil loadGlobalData ulang agar perhitungan bonus
                        // sesuai filter baru dijalankan ulang.
                        if (currentUser) {
                           // Tampilkan loading di tab yang sedang aktif untuk UX
                           const currentTabBtn = document.querySelector('.nav-item.active, .desktop-btn.active');
                           if(currentTabBtn) {
                               const main = document.getElementById('mainContent');
                               main.innerHTML = `<div style="padding:20px; text-align:center;"><div class="spinner"></div><p style="color:#64748b; font-size:13px;">Memperbarui Bonus...</p></div>`;
                           }

                           await loadGlobalData();
                        }

                        // Render UI jika sedang di tab bonus
                        const mobileBtn = document.getElementById('btn-m-bonus');
                        const desktopBtn = document.getElementById('btn-d-bonus');
                        
                        if ((mobileBtn && mobileBtn.classList.contains('active')) || 
                            (desktopBtn && desktopBtn.classList.contains('active'))) {
                            renderBonusTab();
                        }
                    }
                }, (error) => {
                    console.error("Error listening to bonus filter:", error);
                });
            } catch (error) {
                console.error("Error setting up bonus filter listener:", error);
            }
        }

        // --- FUNGSI BARU: LOAD GLOBAL DATA ---
        async function loadGlobalData() {
            try {
                const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
                globalData = window.processGlobalData(stokisSnap);
            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:#ef4444">
                        <h3>‚ùå Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        /* --- INIT --- */
        async function init() {
            try {
                // 1. Load Prices
                await loadMasterPrices();

                // 2. Load Data & Process (Includes Bonus Calculation)
                await loadGlobalData();
                
                // 3. Listeners
                setupInfoBoardListener();
                setupBonusFilterListener(); // NEW: Setup listener

            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:#ef4444">
                        <h3>‚ùå Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>