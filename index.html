<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Skema Point GMRJ</title>
    <style>
        /* --- MODERN BLUE THEME VARIABLES --- */
        :root {
            --color-primary: #1e3a8a;
            --color-primary-light: #3b82f6;
            --color-accent: #2563eb;
            --color-bg: #eff6ff;
            --color-surface: #ffffff;
            --color-text: #0f172a;
            --color-text-light: #64748b;
            --color-border: #dbeafe;
            --shadow-sm: 0 1px 3px 0 rgba(37, 99, 235, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: white;
            /* PERBAIKAN: Padding bawah diperbesar agar judul tidak menempel menu */
            padding: 30px 20px 70px 20px; 
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
            text-align: center;
        }

        .app-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }

        main {
            padding: 20px 16px;
            max-width: 800px;
            margin: 0 auto;
        }

        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            color: var(--color-text-light);
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--color-accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            border: 1px solid white;
            overflow: hidden;
        }

        .card-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title { font-size: 16px; font-weight: 700; color: var(--color-primary); }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 500px;
        }

        th {
            background: #f1f5f9;
            text-align: left;
            padding: 12px 16px;
            font-weight: 700;
            color: var(--color-primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--color-border);
            vertical-align: middle;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        .text-center { text-align: center; }
        .text-right { text-align: right; }

        .rank-badge {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 800;
            font-size: 13px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #d97706); }
        .rank-2 { background: linear-gradient(135deg, #e2e8f0, #94a3b8); }
        .rank-3 { background: linear-gradient(135deg, #fed7aa, #ea580c); }
        .rank-other { background: #e2e8f0; color: #64748b; }

        .score-val { font-weight: 700; color: var(--color-accent); font-size: 14px; }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.2s;
            position: relative;
            z-index: 10; 
        }
        .search-box:focus { border-color: var(--color-accent); }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border-top: 1px solid var(--color-border);
        }

        .btn-page {
            background: white;
            border: 1px solid var(--color-border);
            padding: 8px 20px;
            border-radius: 20px;
            color: var(--color-primary);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-page:active { transform: scale(0.95); background: var(--color-bg); }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; }

        .page-info { font-size: 13px; font-weight: 600; color: var(--color-text-light); }

        /* --- TREE VIEW --- */
        .tree-container {
            padding: 20px;
            overflow: auto;
            background: #ffffff;
            min-height: 300px;
        }

        .tree ul {
            padding-top: 20px;
            position: relative;
            transition: all 0.5s;
            display: flex;
            justify-content: center;
            padding-left: 20px;
        }

        .tree li {
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }

        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 1px solid #cbd5e1;
            width: 50%;
            height: 20px;
        }
        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 1px solid #cbd5e1;
        }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #cbd5e1; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 1px solid #cbd5e1;
            width: 0;
            height: 20px;
        }

        .tree-node {
            border: 1px solid var(--color-border);
            padding: 10px;
            text-decoration: none;
            color: var(--color-text);
            font-size: 11px;
            display: inline-block;
            border-radius: 10px;
            background: white;
            transition: all 0.3s;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            z-index: 2;
        }

        .tree-node:hover {
            border-color: var(--color-accent);
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
        }

        .tree-node strong { display: block; font-size: 13px; color: var(--color-primary); margin-bottom: 2px; }
        .tree-node small { color: var(--color-text-light); font-size: 10px; }

        .tree-node.highlight {
            border-color: var(--color-accent);
            background-color: #dbeafe;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
            transform: scale(1.05);
        }
        .tree-node.highlight strong { color: var(--color-primary); }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--color-text-light);
            font-size: 10px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            flex: 1;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }

        .nav-item.active { color: var(--color-accent); }
        .nav-item.active .nav-icon { transform: translateY(-2px); }

        /* --- DESKTOP LAYOUT --- */
        @media (min-width: 769px) {
            body { padding-bottom: 0; }
            .bottom-nav { display: none; }
            .desktop-nav {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: -40px; /* Pull up to overlap header */
                margin-bottom: 30px;
                position: relative;
                z-index: 20; /* Sit on top of header */
                padding: 0 20px;
            }
            .desktop-btn {
                padding: 12px 28px;
                border-radius: 50px;
                border: none;
                background: white;
                color: var(--color-text-light);
                font-weight: 700;
                font-size: 14px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                cursor: pointer;
                transition: all 0.3s;
            }
            .desktop-btn:hover { 
                color: var(--color-accent); 
                transform: translateY(-3px); 
                box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            }
            .desktop-btn.active {
                background: var(--color-accent);
                color: white;
                box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            }
        }
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .app-title { font-size: 18px; }
            /* Reset padding for mobile since menu is gone */
            header { padding-bottom: 24px; } 
        }
    </style>
</head>
<body>

    <header>
        <div class="app-title">Skema Point GMRJ</div>
    </header>

    <div class="desktop-nav">
        <button class="desktop-btn active" id="btn-d-stokis" onclick="window.switchTab('stokis')">üèÜ Ranking Stokis</button>
        <button class="desktop-btn" id="btn-d-member" onclick="window.switchTab('member')">üíé Top Member</button>
        <button class="desktop-btn" id="btn-d-tree" onclick="window.switchTab('tree')">üå≥ Pohon Jaringan</button>
    </div>

    <main id="mainContent">
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Memuat data...</p>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" id="btn-m-stokis" onclick="window.switchTab('stokis')">
            <span class="nav-icon">üèÜ</span>
            <span>Stokis</span>
        </button>
        <button class="nav-item" id="btn-m-member" onclick="window.switchTab('member')">
            <span class="nav-icon">üíé</span>
            <span>Member</span>
        </button>
        <button class="nav-item" id="btn-m-tree" onclick="window.switchTab('tree')">
            <span class="nav-icon">üå≥</span>
            <span>Jaringan</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7i0bGhjKHZ788Ir7xTDFM0LXAevnWKsI",
            authDomain: "sistem-stokis-gmrj.firebaseapp.com",
            projectId: "sistem-stokis-gmrj",
            storageBucket: "sistem-stokis-gmrj.firebasestorage.app",
            messagingSenderId: "288883517168",
            appId: "1:288883517168:web:d5cdd864aa944205df8435",
            measurementId: "G-12KELDXJ1J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_STOKIS = 'stokisDatas';

        let globalData = null;
        let treeState = { nodes: [] };
        let filteredMembers = [];
        let memberPage = 1;
        const MEMBERS_PER_PAGE = 10;

        // --- GLOBAL HELPER FUNCTIONS ---
        window.processGlobalData = function(snapshot) {
            const result = {
                stokisList: [],
                membersMap: new Map()
            };

            snapshot.forEach(doc => {
                const sId = doc.id;
                const sData = doc.data();
                const sName = sData.profile?.namaStokis || sId;
                let sPoints = 0;
                let sMemberCount = sData.members?.length || 0;
                let sSalesPoints = 0;

                sData.members?.forEach(m => {
                    const mId = m.id;
                    const mPoints = m.totalPoints || 0;
                    sPoints += mPoints;

                    if (!result.membersMap.has(mId)) {
                        result.membersMap.set(mId, {
                            id: mId,
                            name: m.name,
                            points: 0,
                            upline: m.upline,
                            stokisSources: []
                        });
                    }

                    const globalMember = result.membersMap.get(mId);
                    globalMember.points += mPoints;
                    globalMember.stokisSources.push(sName);
                    if (!globalMember.name || globalMember.name === 'NA') globalMember.name = m.name;
                    if (m.upline) globalMember.upline = m.upline;
                });

                sData.transactions?.forEach(t => {
                    sSalesPoints += parseFloat(t.totalPoints || 0);
                });

                result.stokisList.push({
                    id: sId,
                    name: sName,
                    totalPoints: sPoints,
                    salesPoints: sSalesPoints,
                    memberCount: sMemberCount
                });
            });
            return result;
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-item, .desktop-btn').forEach(btn => btn.classList.remove('active'));
            
            const mobileBtn = document.getElementById(`btn-m-${tabName}`);
            const desktopBtn = document.getElementById(`btn-d-${tabName}`);
            if(mobileBtn) mobileBtn.classList.add('active');
            if(desktopBtn) desktopBtn.classList.add('active');

            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tabName === 'stokis') renderStokisRanking();
            if (tabName === 'member') renderMemberRanking();
            if (tabName === 'tree') renderNetworkTree();
        };

        window.toggleNode = function(id) {
            function traverse(list) {
                for (const n of list) {
                    if (n.id === id) {
                        n.expanded = !n.expanded;
                        return true;
                    }
                    if (n.children && traverse(n.children)) return true;
                }
            }
            traverse(treeState.nodes);
            renderTreeHTML();
        };

        window.searchTreeNode = function() {
            const query = document.getElementById('treeSearch').value.toLowerCase();

            const collapseAll = (list) => {
                list.forEach(n => {
                    n.expanded = false;
                    n.highlight = false;
                    if(n.children) collapseAll(n.children);
                });
            };
            collapseAll(treeState.nodes);

            if (!query) {
                renderTreeHTML();
                return;
            }

            const traverseAndExpandParents = (nodeList, parents = []) => {
                let found = false;
                nodeList.forEach(node => {
                    const isMatch = node.name.toLowerCase().includes(query) || node.id.toLowerCase().includes(query);
                    
                    if (isMatch) {
                        node.highlight = true;
                        found = true;
                        parents.forEach(p => p.expanded = true);
                    }

                    if (node.children) {
                        if (traverseAndExpandParents(node.children, [...parents, node])) {
                            found = true;
                        }
                    }
                });
                return found;
            };

            traverseAndExpandParents(treeState.nodes);
            renderTreeHTML();
        };

        window.filterMembers = function() {
            const query = document.getElementById('memberSearch').value.toLowerCase();
            const allMembers = Array.from(globalData.membersMap.values());
            filteredMembers = allMembers.filter(m => 
                m.name.toLowerCase().includes(query) || 
                m.id.toLowerCase().includes(query)
            );
            memberPage = 1;
            updateMemberTableContent(); 
        };

        window.changePage = function(delta) {
            memberPage += delta;
            updateMemberTableContent();
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        };

        // --- RENDER FUNCTIONS ---

        function renderStokisRanking() {
            const sortedStokis = [...globalData.stokisList].sort((a, b) => b.salesPoints - a.salesPoints);

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üèÜ Ranking Stokis</span>
                        <span class="badge" style="background:#dbeafe; color:#1e40af; padding:4px 8px; border-radius:4px; font-size:11px;">Total: ${sortedStokis.length}</span>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center" width="50">Rank</th>
                                    <th>Nama Stokis</th>
                                    <th class="text-center">Member</th>
                                    <th class="text-right">Omset Point</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            sortedStokis.forEach((s, idx) => {
                let rankClass = 'rank-other';
                if (idx === 0) rankClass = 'rank-1';
                if (idx === 1) rankClass = 'rank-2';
                if (idx === 2) rankClass = 'rank-3';

                html += `
                    <tr>
                        <td class="text-center"><div class="rank-badge ${rankClass}">${idx + 1}</div></td>
                        <td><strong>${s.name}</strong></td>
                        <td class="text-center">${s.memberCount}</td>
                        <td class="text-right score-val">${s.salesPoints.toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div></div>`;
            document.getElementById('mainContent').innerHTML = html;
        }

        function renderMemberRanking() {
            const allMembers = Array.from(globalData.membersMap.values()).sort((a, b) => b.points - a.points);
            filteredMembers = allMembers;
            memberPage = 1;

            let html = `
                <div class="card">
                    <div class="card-header" style="flex-direction:column; align-items:flex-start; gap:10px;">
                        <span class="card-title">üíé Top Member (Global ID)</span>
                        <input type="text" id="memberSearch" class="search-box" placeholder="üîç Cari Nama atau ID..." onkeyup="window.filterMembers()">
                    </div>
                    
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center" width="50">R</th>
                                    <th>Nama Member</th>
                                    <th>ID</th>
                                    <th class="text-right">Poin</th>
                                </tr>
                            </thead>
                            <tbody id="memberTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="memberPagination">
                        <button class="btn-page" id="memberBtnPrev" onclick="window.changePage(-1)">Sebelumnya</button>
                        <span class="page-info" id="memberPageInfo">Hal 1</span>
                        <button class="btn-page" id="memberBtnNext" onclick="window.changePage(1)">Selanjutnya</button>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            updateMemberTableContent();
        }

        function updateMemberTableContent() {
            const start = (memberPage - 1) * MEMBERS_PER_PAGE;
            const end = start + MEMBERS_PER_PAGE;
            const pagedData = filteredMembers.slice(start, end);
            const totalMembers = filteredMembers.length;
            const totalPages = Math.ceil(totalMembers / MEMBERS_PER_PAGE);

            const tbody = document.getElementById('memberTableBody');
            let rows = '';
            if (pagedData.length === 0) {
                rows = `<tr><td colspan="4" class="text-center" style="padding:30px; color:#94a3b8;">Tidak ada data ditemukan.</td></tr>`;
            } else {
                pagedData.forEach((m, idx) => {
                    const globalRank = start + idx + 1;
                    let rankClass = 'rank-other';
                    if (globalRank === 1) rankClass = 'rank-1';
                    if (globalRank === 2) rankClass = 'rank-2';
                    if (globalRank === 3) rankClass = 'rank-3';

                    rows += `
                        <tr>
                            <td class="text-center"><div class="rank-badge ${rankClass}" style="width:24px; height:24px; font-size:11px;">${globalRank}</div></td>
                            <td><strong>${m.name}</strong></td>
                            <td style="font-family:monospace; color:#64748b; font-size:11px;">${m.id}</td>
                            <td class="text-right score-val">${parseFloat(m.points).toFixed(2)}</td>
                        </tr>
                    `;
                });
            }
            tbody.innerHTML = rows;

            const pInfo = document.getElementById('memberPageInfo');
            const pDiv = document.getElementById('memberPagination');
            const btnPrev = document.getElementById('memberBtnPrev');
            const btnNext = document.getElementById('memberBtnNext');

            if (totalPages <= 1) {
                pDiv.style.display = 'none';
            } else {
                pDiv.style.display = 'flex';
                if(pInfo) pInfo.textContent = `Hal ${memberPage} dari ${totalPages}`;
                if(btnPrev) btnPrev.disabled = (memberPage === 1);
                if(btnNext) btnNext.disabled = (memberPage === totalPages);
            }
        }

        function renderNetworkTree() {
            const nodes = new Map();
            
            globalData.membersMap.forEach(m => {
                nodes.set(m.id, {
                    id: m.id,
                    name: m.name,
                    points: m.points,
                    children: [],
                    expanded: false,
                    highlight: false
                });
            });

            const roots = [];
            const childIds = new Set();

            globalData.membersMap.forEach(m => {
                const node = nodes.get(m.id);
                if (m.upline && nodes.has(m.upline)) {
                    const parent = nodes.get(m.upline);
                    if (!parent.children.includes(node)) {
                        parent.children.push(node);
                    }
                    childIds.add(m.id);
                }
            });

            nodes.forEach(node => {
                if (!childIds.has(node.id)) {
                    roots.push(node);
                    node.expanded = true;
                }
            });

            treeState.nodes = roots;

            let html = `
                <div class="card">
                    <div class="card-header" style="flex-direction:column; align-items:flex-start; gap:10px;">
                        <span class="card-title">üå≥ Pohon Jaringan</span>
                        <input type="text" id="treeSearch" class="search-box" placeholder="üîç Cari Nama / ID..." onkeyup="window.searchTreeNode()">
                    </div>
                    <div class="tree-container tree">
                        <div id="treeRoot"></div>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = html;
            renderTreeHTML();
        }

        function renderTreeHTML() {
            const container = document.getElementById('treeRoot');
            if (!container) return;

            const buildTreeHtml = (nodeList) => {
                if (!nodeList || nodeList.length === 0) return '';
                return `<ul>${nodeList.map(node => {
                    const hasChildren = node.children && node.children.length > 0;
                    const isExpanded = node.expanded;
                    let childrenHtml = '';
                    if (hasChildren && isExpanded) {
                        childrenHtml = buildTreeHtml(node.children);
                    }
                    
                    const highlightClass = node.highlight ? 'highlight' : '';

                    return `
                        <li>
                            <div class="tree-node ${highlightClass}" onclick="window.toggleNode('${node.id.replace(/'/g, "\\'")}')">
                                ${hasChildren 
                                    ? `<span style="color:var(--color-accent); margin-right:5px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>` 
                                    : `<span style="width:12px; display:inline-block;"></span>`
                                }
                                <strong>${node.name}</strong>
                                <small>${parseFloat(node.points).toFixed(0)} pts</small>
                            </div>
                            ${childrenHtml}
                        </li>
                    `;
                }).join('')}</ul>`;
            };

            container.innerHTML = buildTreeHtml(treeState.nodes);
        }

        async function init() {
            try {
                const stokisSnap = await getDocs(collection(db, COLLECTION_STOKIS));
                globalData = window.processGlobalData(stokisSnap);
                window.switchTab('stokis');
            } catch (error) {
                document.getElementById('mainContent').innerHTML = `
                    <div class="card" style="padding:30px; text-align:center; color:#ef4444;">
                        <h3>‚ö†Ô∏è Error Koneksi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>